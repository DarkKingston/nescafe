<?php

use Drupal\Core\Url;
use Drupal\Core\StringTranslation\TranslatableMarkup;
use Platformsh\ConfigReader\Config;
use Drupal\Core\Form\ConfigFormBase;
use Drupal\Core\Form\FormStateInterface;
use Symfony\Component\DependencyInjection\ContainerInterface;
use Drupal\user\Entity\User;
use Drupal\media\Entity\Media;
use Drupal\file\Entity\File;
use Drupal\Core\Entity\EntityTypeManagerInterface;

// sms BULK start
function apiBulkSmsSystem( $params )
{
  // СТАНДАРТНЫЕ НАСТРОЙКИ
  $_PID = '23280001-A04F-45AD-8383-A653379182C4';
  $_ACCOUNT_NUMBER = '2328000149801';
  $_UTS = time();
  $_PASSWORD = 'Y6j5zAiHhk8w9lclZ1cDL9hyG7fxRPAH';
  $result = array(
    'status' => false ,
    'message' => '' ,
    'code' => 0 ,
    'date' => '' ,
    'balance' => ''
  );
  switch ( $params['type'] )
  {
    case 'GetBalance': // получение остаткан а счету
      $URL = 'https://ext.123api.xyz/ED3B8F6F-A218-486B-871E-9654B1221DCA/Get_Balance.php';
      $_PHASH = md5($_PID . $_UTS . $_ACCOUNT_NUMBER . $_PASSWORD );
      $ar = array(
        'PID' => $_PID , // является уникальным кодом Партнера
        'UTS' => $_UTS ,
        'Account' => $_ACCOUNT_NUMBER ,
        'PHASH' => $_PHASH , // это хеш пароля
      );
      break;
    case 'SendSms': // отправка сообщения

      $MESSAGE = $params['message'];
      $PHONE = $params['phone']; // формате Е.164. // 37360892310
      $URL = 'https://ext.123api.xyz/ED3B8F6F-A218-486B-871E-9654B1221DCA/Send_SMS_Notification.php';
      $_PHASH = md5( $_PID . $_PASSWORD . $PHONE );
      $ar = array(
        'PID' => $_PID , // является уникальным кодом Партнера
        'PHASH' => $_PHASH , // это хеш пароля
        'DNIS' => $PHONE , // формате Е.164.
        'ANI' => '',
        'Alias' => 'NESCAFE',
        'Enc' => 'UTF8',
        'BMess' => $MESSAGE
      );
      $ar['BMess'] = str_replace("&", "%26", $ar['BMess']);
      $ar['BMess'] = str_replace("+", "%2B", $ar['BMess']);
      break;
  }
  $ReqString = json_encode( $ar );
  $ch = curl_init();
  curl_setopt( $ch , CURLOPT_URL, $URL);
  curl_setopt( $ch , CURLOPT_RETURNTRANSFER, 1);
  curl_setopt( $ch , CURLOPT_HEADER, 0);
  curl_setopt( $ch , CURLOPT_SSL_VERIFYHOST, false);
  curl_setopt( $ch , CURLOPT_SSL_VERIFYPEER, false);
  curl_setopt( $ch , CURLOPT_POST, true);
  curl_setopt( $ch , CURLOPT_POSTFIELDS, "Request=".$ReqString );
  curl_setopt( $ch , CURLOPT_CONNECTTIMEOUT, 3 );
  $data = curl_exec( $ch );
  $result['curl_response'] = $data;
  if ( !curl_errno( $ch ) )
  {
    try {
      $data_arr = json_decode( $data , true );
      if( $data_arr['RStatus'] == '0' )
      {
        $result['status'] = true;
        // в случае проверки баланса
        if( isset( $data_arr['RStatus'] ) ) {
          $result['date'] = @$data_arr['Date'];
          $result['balance'] = @$data_arr['Balance'];
        }
      }
      else
      {
        $result['message'] = $data_arr['ErrorMessage'] . ' || NRID - ' . $data_arr['NRID'];
        $result['code'] = $data_arr['RStatus'];
      }
    } catch (Exception $e) {
      $result['message'] = 'Error json decode';
    }
  }
  else
  {
    $result['message'] = curl_error( $ch );
  }
  curl_close( $ch );
  return $result;
}
// sms BULK end

function nescafe_preprocess_links__language_block(&$lang)
{
    $lang['current_lang'] =  \Drupal::languageManager()->getCurrentLanguage()->getId();
}


function nescafe_preprocess_menu__header_btn(&$logged)
{

    $current_user = \Drupal::currentUser();


    if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
        if ($current_user->isAnonymous()) {
            // Анонимный юзер...
            print '<div class="cookie_success" style="opacity: 0;height: 0;">ok</div>';
            $logged['items']['menu_link_content:782f8d36-a980-4feb-95ab-0c3a0da00875']['title'] = t('Зарегистрируйся и выиграй');
        }

        if ($current_user->isAuthenticated()) {
            // Авторизованный юзер...
            $routeName = new TranslatableMarkup('view.account.page_1');
            $logged['items']['menu_link_content:782f8d36-a980-4feb-95ab-0c3a0da00875']['title'] = t('Личный кабинет');
            $logged['items']['menu_link_content:782f8d36-a980-4feb-95ab-0c3a0da00875']['url'] = Url::fromRoute($routeName->getUntranslatedString());
        }
    }
    if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
        if ($current_user->isAnonymous()) {
            // Анонимный юзер...
            print '<div class="cookie_success" style="opacity: 0;height: 0;">ok</div>';
            $logged['items']['menu_link_content:782f8d36-a980-4feb-95ab-0c3a0da00875']['title'] = t('Înregistrează-te și câștigă');
        }

        if ($current_user->isAuthenticated()) {
            // Авторизованный юзер...
            $routeName = new TranslatableMarkup('view.account.page_1');
            $logged['items']['menu_link_content:782f8d36-a980-4feb-95ab-0c3a0da00875']['title'] = t('Cabinet personal');
            $logged['items']['menu_link_content:782f8d36-a980-4feb-95ab-0c3a0da00875']['url'] = Url::fromRoute($routeName->getUntranslatedString());
        }
    }
}

/*$current_path = \Drupal::service('path.current')->getPath();*/


function nescafe_preprocess_page(&$page)
{
  $roles = \Drupal::currentUser()->getRoles();


  $config = new Config();

  $credentials = $config->credentials('database');

  $dsn = sprintf('mysql:host=%s;port=%d;dbname=%s', $credentials['host'], $credentials['port'], $credentials['path']);
  $conn = new \PDO($dsn, $credentials['username'], $credentials['password'], [
    \PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION,
    \PDO::MYSQL_ATTR_USE_BUFFERED_QUERY => TRUE,
    \PDO::MYSQL_ATTR_FOUND_ROWS => TRUE,
  ]);

  $curr_id_for_user = \Drupal::currentUser()->id();


  $ifActive = "SELECT * FROM user__field_active_account WHERE entity_id = '".$curr_id_for_user."' AND field_active_account_value = 1 LIMIT 1";
  $resultActive = $conn->query($ifActive);
  $resultActive->setFetchMode(\PDO::FETCH_OBJ);
  $counter = 0;
  foreach ($resultActive as $recordActive) {
    $counter++;
  }
  if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
    $codeSubmit = "Введите код из SMS";
    $errSubmit = "Вы ввели неправильный код";
    $btnText = "Введите еще раз";
    $btnVerify = "Подтвердить";
  }
  if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
    $codeSubmit = "Introduceți codul din SMS";
    $errSubmit = "Ați introdus cod greșit";
    $btnText = "Introduceți încă o dată";
    $btnVerify = "Verifică";
  }

    if ($counter == 0 && $curr_id_for_user != 0) {
      if (!isset($_SESSION['code'])) {
        $code = rand(1000, 9999);
        $_SESSION['code'] = $code;
        print "<div class='bg_noactive'>
              <form method='post' class='nonactive_user'>
                    <div class=''>".$codeSubmit."</div>
                    <input type='text' placeholder='code' name='code_name' style='margin-top: 10px; margin-bottom: 10px;'>
                    <input type='submit' style='margin:0 auto;display:flex; justify-content: center;' name='verify_submit' value='".$btnVerify."' class='btn_main action search_filiala form_btn'>
               </form>
              </div>";

        $phone = User::load($curr_id_for_user)->get('name')->value;
        $params = array(

          'type' => 'SendSms' ,

          'phone' => $phone ,

          'message' => 'Codul pentru confirmarea numarului de telefon: '.$code.' '

        );
        $resultSend = apiBulkSmsSystem( $params );
      }


        if(isset($_POST['verify_submit'])){
                if ($_POST['code_name'] == $_SESSION['code']) {
                  $user = User::load($curr_id_for_user);
                  $user->set('field_active_account', 1);
                  $user->save();
                  unset($_SESSION["code"]);
                  header("Location: /account");
                }else{
                  unset($_SESSION["code"]);
                  print "<div class='bg_noactive'>
                  <form method='post' class='nonactive_user'>
                        <div class=''>".$errSubmit."</div>
                        <input type='submit' style='margin:0 auto; display:flex; justify-content: center;' value='".$btnText."' class='btn_main action search_filiala form_btn'>
                   </form>
                  </div>";
                }
        }



    } else {
      // Поле field_active_account присутствует у пользователя.
      // Вы можете выполнить необходимые действия здесь.

    }



    //dump($page);

    if (!in_array('player', $roles) && !in_array('administrator', $roles) && !in_array('manager_filiala', $roles)) {
        $role_id = 'player';

        $user = User::load($curr_id_for_user);

        $user->addRole($role_id);
        $user->save();
    }

    if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
        $cookie = "Мы используем cookies для улучшения вашего опыта использования сайта.";
        $accept = "Принять";
        $reject = "Не принимаю";
    }
    if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
        $cookie = "Folosim cookies pentru a îmbunătăți experiența ta de utilizare a site-ului.";
        $accept = "Accept";
        $reject = "Nu accept";
    }
    if ($curr_id_for_user != 0) {
        if (isset($_POST['cookie_accept'])) {
            $insertCookie = "INSERT INTO cookie (ip, date)VALUES('$curr_id_for_user', NOW())";
            if ($conn->query($insertCookie)) {
                //echo "ok";
            }
            $_SESSION['cookie'] = 'accept';
        }
        if (isset($_POST['cookie_reject'])) {
            $_SESSION['cookie'] = 'no';
        }


        $sql = "SELECT * FROM cookie WHERE ip = '" . $curr_id_for_user . "' ";
        $result = $conn->query($sql);
        $result->setFetchMode(\PDO::FETCH_OBJ);

        if ($result) {
            foreach ($result as $record) {
            }
        }
        if (isset($record)) {
            $hidden = 'hidden';
        }
        if (empty($record)) {
            $hidden = '';


            print "<div class='cookie " . $hidden . "'>
                    <div class='cookie_box'>
                      <div class='cookie_title'>
                        ".$cookie."
                      </div>
                      <div class='cookie_subtitle'>
                        Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry standard
                      </div>

                      <form method='post'>
                            <input type='submit' name='cookie_reject' class='cookie_reject' value='" . $reject . "'>
                            <input type='submit' name='cookie_accept' class='cookie_accept' value='" . $accept . "'>
                      </form>

                        </div>
                  </div>";
        }
    } else {
        if ($_SESSION['cookie'] != 'accept') {
            if (isset($_POST['cookie_reject'])) {
                $_SESSION['cookie'] = 'accept';
                $hidden = 'hidden';
            }
            if (isset($_POST['cookie_accept'])) {
                $_SESSION['cookie'] = 'accept';
                $hidden = 'hidden';
            }
            print "<div class='cookie " . $hidden . "'>
            <div class='cookie_box'>
              <div class='cookie_title'>
                ".$cookie."
              </div>
              <div class='cookie_subtitle'>
                Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry standard
              </div>

              <form method='post'>
                    <input type='submit' name='cookie_reject' class='cookie_reject' value='" . $reject . "'>
                    <input type='submit' name='cookie_accept' class='cookie_accept' value='" . $accept . "'>
              </form>

                </div>
            </div>";
        }
    }


    if (isset($_POST['reglamentAccept'])) {
        $_SESSION['reglament'] = 'accept';
        header("Location: /register");
    };

    if ($_SESSION['reglament'] == 'accept') {
        print "<div class='reg_accept hidden'>regaccept</div>";
    }


}


function nescafe_preprocess_region__account(&$elem)
{
    $curr_id_for_user = \Drupal::currentUser()->id();

    $config = new Config();

    $credentials = $config->credentials('database');

    $dsn = sprintf('mysql:host=%s;port=%d;dbname=%s', $credentials['host'], $credentials['port'], $credentials['path']);
    $conn = new \PDO($dsn, $credentials['username'], $credentials['password'], [
        \PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION,
        \PDO::MYSQL_ATTR_USE_BUFFERED_QUERY => TRUE,
        \PDO::MYSQL_ATTR_FOUND_ROWS => TRUE,
    ]);

    $roles = \Drupal::currentUser()->getRoles();

    if (isset($_POST['introduceti_codul_promotional'])) {
        $config = new Config();
        $credentials = $config->credentials('database');
        $dsn = sprintf('mysql:host=%s;port=%d;dbname=%s', $credentials['host'], $credentials['port'], $credentials['path']);
        $conn = new \PDO($dsn, $credentials['username'], $credentials['password'], [
            \PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION,
            \PDO::MYSQL_ATTR_USE_BUFFERED_QUERY => TRUE,
            \PDO::MYSQL_ATTR_FOUND_ROWS => TRUE,
        ]);

      if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
        $codeRepeat = "Этот код уже был введен.";
        $codeSuccess = "Код успешно зарегестрирован!";
        $codeClose = "Закрыть";
      }
      if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
        $codeRepeat = "Acest cod deja a fost introdus.";
        $codeSuccess = "Cod înregistrat cu success!";
        $codeClose = "Închide";
      }

        $sql = "SELECT * FROM promo_code WHERE active = 0 AND promocode = '".$_POST['introduceti_codul_promotional']."' ";
        $result = $conn->query($sql);
        $result->setFetchMode(\PDO::FETCH_OBJ);

        if ($result) {
            foreach ($result as $record) {
                if ($record->active == 0) {
                    $sql = "UPDATE promo_code SET active = '" . $curr_id_for_user . "',  data = NOW() WHERE promocode = '" . $_POST['introduceti_codul_promotional'] . "' AND active = 0  ";

                  print "<form method='POST' class='use-ajax webform-dialog webform-dialog-narrow popup_gift' data-dialog-type='modal'>
                                             <div class='center'>".$codeSuccess."</div>
                                             <div class='btn_main action closePopup'>".$codeClose."</div>
                                         </form>
                                         ";
                }
            }
            if ($conn->query($sql)) {
                //echo 'ok';
            }
        }
    }

    /*Для администратора*/
    if (in_array('authenticated', $roles) && in_array('administrator', $roles)) {
        if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
            $name = 'Имя';
            $last_name = "Фамилия";
            $phone = 'Телефон';
            $action = "Детали";
            $stats = 'Сток';
            $prem = 'Приз';
            $livrare = 'Филиал';
            $promoCode = "Промокод";
            $tombola = 'Лотерея';
            $tabel = 'Главный';
        }
        if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
            $name = 'Nume';
            $last_name = "Prenume";
            $phone = "Telefon";
            $action = 'Detalii';
            $stats = 'Stoc';
            $tombola = 'Tombola';
            $prem = 'Premiu';
            $livrare = 'Filiala';
            $promoCode = "Promocod";
            $tabel = 'Principal';
        }

        $sqlQuery = "SELECT * FROM users_field_data LEFT JOIN `user__field_phone` ON `users_field_data`.`uid` = `user__field_phone`.`revision_id` LEFT JOIN `promo_code` ON `users_field_data`.uid = `promo_code`.active  LEFT JOIN `user__field_name` ON `users_field_data`.`uid` = `user__field_name`.`entity_id` LEFT JOIN `user__field_lastname` ON `users_field_data`.`uid` = `user__field_lastname`.`entity_id`  WHERE uid != 0 AND `promo_code`.`active` != 0 AND `promo_code`.`status` != 0 AND `promo_code`.`status` != 1 ORDER BY uid ASC";

        if (isset($_POST['filSearch']) && $_POST['filiala_inp'] != '') {
            if ($_POST['filiala_inp'] == 'Toate' || $_POST['filiala_inp'] == 'Все') {
                $sqlQuery = "SELECT * FROM users_field_data LEFT JOIN `user__field_phone` ON `users_field_data`.`uid` = `user__field_phone`.`revision_id` LEFT JOIN `promo_code` ON `users_field_data`.uid = `promo_code`.active  LEFT JOIN `user__field_name` ON `users_field_data`.`uid` = `user__field_name`.`entity_id` LEFT JOIN `user__field_lastname` ON `users_field_data`.`uid` = `user__field_lastname`.`entity_id`  WHERE uid != 0 AND `promo_code`.`active` != 0 AND `promo_code`.`status` != 0 AND `promo_code`.`status` != 1 ORDER BY uid ASC";
            } else {
                $sqlQuery = "SELECT * FROM users_field_data LEFT JOIN `user__field_phone` ON `users_field_data`.`uid` = `user__field_phone`.`revision_id` LEFT JOIN `promo_code` ON `users_field_data`.uid = `promo_code`.active LEFT JOIN `user__field_name` ON `users_field_data`.`uid` = `user__field_name`.`entity_id` LEFT JOIN `user__field_lastname` ON `users_field_data`.`uid` = `user__field_lastname`.`entity_id` WHERE uid != 0 AND `promo_code`.`active` != 0 AND `promo_code`.`status` != 0 AND `promo_code`.`status` != 1 AND `promo_code`.`livrare` = '" . $_POST['filiala_inp'] . "' ORDER BY uid ASC";
            }
        } else {
            $sqlQuery = "SELECT * FROM users_field_data LEFT JOIN `user__field_phone` ON `users_field_data`.`uid` = `user__field_phone`.`revision_id` LEFT JOIN `promo_code` ON `users_field_data`.uid = `promo_code`.active LEFT JOIN `user__field_name` ON `users_field_data`.`uid` = `user__field_name`.`entity_id` LEFT JOIN `user__field_lastname` ON `users_field_data`.`uid` = `user__field_lastname`.`entity_id` WHERE uid != 0 AND `promo_code`.`active` != 0 AND `promo_code`.`status` != 0 AND `promo_code`.`status` != 1  ORDER BY uid ASC";
        }

        $sql = $sqlQuery;
        //dump($sql);
        $result = $conn->query($sql);
        $result->setFetchMode(\PDO::FETCH_OBJ);

        print <<<TABLE
          <table id="table8">
          <thead>
          <tr><th>ID</th><th>$name</th><th>$last_name</th><th>$phone</th><th>$prem</th><th>$livrare</th><th>$promoCode</th><th>$action</th></tr>
          </thead>
          <tbody>
          TABLE;
        $count = 1;
        foreach ($result as $record) {
            //dump($record);
            printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td><a href='/details?id=%s' data-id='%s' class='btn_main action'>%s</a></td></tr>\n", $count, $record->field_name_value,$record->field_lastname_value, $record->name, $record->premiu, $record->livrare, $record->promocode, $record->uid, $record->uid, $action);

            $count++;
        }

      if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
        $all = 'Все';
        $chis = 'Chișinău';
        $comr = 'Comrat';
        $edinet = 'Edineț';
        $cahul = 'Cahul';
        $balt = 'Bălți';
        $sort = 'Сортировка по филиалу';
        $logout = 'Выход';
        $search = 'Поиск';
      }
      if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
        $sort = 'Sortare după filială';
        $all = 'Toate';
        $chis = 'Chișinău';
        $comr = 'Comrat';
        $edinet = 'Edineț';
        $cahul = 'Cahul';
        $balt = 'Bălți';
        $logout = 'Ieșire';
        $search = 'Caută';
      }
        print "</tbody>\n</table>\n";
        print "<div class='admin_btns'>
          <a href='/tabel-principal' class='btn_main stock'>" . $tabel . "</a>
          <a href='/stock' class='btn_main stock logout_btn'>" . $stats . "</a>
          <a href='/tombola' class='btn_main stock logout_btn'>" . $tombola . "</a>
          <a href='/user/logout' class='btn_main stock logout_btn'>".$logout."</a>
          <div class='text_content search_fil'>".$sort."</div>
          <form method='post'>
             <select name='filiala_inp'>
                 <option>".$all."</option>
                 <option>".$chis."</option>
                 <option>".$comr."</option>
                 <option>".$edinet."</option>
                 <option>".$cahul."</option>
                 <option>".$balt."</option>
             </select>
             <input type='submit' name='filSearch' value='".$search."' class='btn_main action search_filiala'>
          </form>
          </div>";
    }

    /* Sql запросы по ролям */

    //if(in_array('administrator', $roles)) {
    //    $sqlQuery = "SELECT * FROM promo_code WHERE active <> 0";
    //    $sqlQuery = "SELECT * FROM promo_code WHERE active <> 0";
    //}
    if (in_array('player', $roles) && !in_array('administrator', $roles)) {
        $sqlQuery = "SELECT * FROM promo_code WHERE active = '" . $curr_id_for_user . "' ORDER BY data ASC";
    }
    if (in_array('authenticated', $roles) && in_array('manager_filiala', $roles) && !in_array('administrator', $roles)) {
        if (isset($_POST['submitSearch']) && $_POST['search'] != '') {
            $sqlQuery = "SELECT * FROM users_field_data LEFT JOIN `promo_code` ON `users_field_data`.uid = `promo_code`.active  LEFT JOIN `user__field_name` ON `users_field_data`.`uid` = `user__field_name`.`entity_id` LEFT JOIN `user__field_lastname` ON `users_field_data`.`uid` = `user__field_lastname`.`entity_id`  WHERE uid != 0 AND  `users_field_data`.`name` LIKE '%" . $_POST['search'] . "%' AND `promo_code`.`active` != 0 AND `promo_code`.`status` = 2 ";
            //dump($_POST);
        } else {
            $sqlQuery = "SELECT * FROM users_field_data LEFT JOIN `promo_code` ON `users_field_data`.uid = `promo_code`.active  LEFT JOIN `user__field_name` ON `users_field_data`.`uid` = `user__field_name`.`entity_id` LEFT JOIN `user__field_lastname` ON `users_field_data`.`uid` = `user__field_lastname`.`entity_id` WHERE uid != 0 AND `promo_code`.`active` != 0 AND `promo_code`.`status` = 2 ORDER BY uid ASC";
        }
    }



    // Кастомный запрос по ролям приравниваю к переменной sql
    if ($sqlQuery != '') {
        $sql = $sqlQuery;
        //dump($sql);
        $result = $conn->query($sql);
        $result->setFetchMode(\PDO::FETCH_OBJ);
        $sql2 = "SELECT * FROM promo_code WHERE active <> 0";
        $result2 = $conn->query($sql2);
        $result2->setFetchMode(\PDO::FETCH_OBJ);
        //dump($conn->query($sql));
        if ($result) {
            if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
                $promo = 'Промо код';
                $number = 'Выйгрыш';
                $filial = 'Филиал';
                $send = 'Проверить';
                $intro = 'Вводите промо-код';
                $status = 'Статус';
                $stateON = "Выдан в -> ";
                $stateOFF = "В ожидании";
            }
            if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
                $promo = 'Codul Promotional';
                $number = 'Premiu';
                $filial = 'Filiala';
                $send = 'Verifică';
                $intro = 'Întroduceți codul promoțional';
                $status = 'Statut';
                $stateON = "Ridicat în -> ";
                $stateOFF = "În Asteptare";
            }

            /*Обычный пользователь Вывод промокодов который он вводил*/
            if (in_array('player', $roles) && !in_array('manager_filiala', $roles) && !in_array('administrator', $roles)) {

                print <<<TABLE
<table id="table8">
<thead>
<tr><th>ID</th><th>$promo</th><th>$number</th><th>$filial</th><th>$status</th></tr>
</thead>
<tbody>
TABLE;
                $count = 1;
                $score = 0;
                $total = 0;
                $promoTotal = 0;
                foreach ($result2 as $record2) {
                    //dump($record2);
                    if (!preg_match("/^([0-9])+$/", $record2->promocode)) {
                        $promoTotal += 1;
                    } else {
                        $promoTotal += 1;
                    }
                }
                foreach ($result as $record) {

                    if ($result) {
                        if (!preg_match("/^([0-9])+$/", $record->promocode)) {
                            $score = 2;
                            $total += 1;
                        } else {
                            $score = 1;
                            $total += 1;
                        }
                      if ($record->status == 2) {
                        $statusPrint = $stateOFF;
                      } else if ($record->status == 3) {
                        $statusPrint = $stateON;
                      } else {
                        $statusPrint = '';
                      }

                        printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $record->promocode, $record->premiu, $record->livrare, $statusPrint.$record->filiala_elib);

                        $count++;
                    }
                }
              if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
                $logout = 'Выход';
                $zilTombolaTxt = "Вы являетесь участником ежедневной лотереи";
                $finTombolaTxt = "Вы являетесь участником финального розыгрыша";
              }
              if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
                $logout = 'Ieșire';
                $zilTombolaTxt = "Sunteți participant la tombola zilnică";
                $finTombolaTxt = "Sunteți participant la tombolă finală";
              }
              $checkTombola = "SELECT * FROM promo_code WHERE tombola = 1 AND active = '".$curr_id_for_user."' ";
              $resultcheckTombola = $conn->query($checkTombola);
              $resultcheckTombola->setFetchMode(\PDO::FETCH_OBJ);
              $checkCounterTombola = 0;
              foreach($resultcheckTombola as $resCheck){
                $checkCounterTombola++;
              }
              $checkTombolaFin = "SELECT * FROM promo_code WHERE final = 1 AND active = '".$curr_id_for_user."' ";
              $resultcheckTombolaFin = $conn->query($checkTombolaFin);
              $resultcheckTombolaFin->setFetchMode(\PDO::FETCH_OBJ);
              $checkCounterTombolaFin = 0;
              foreach($resultcheckTombola as $resCheck){
                $checkCounterTombolaFin++;
              }
              $tombolaZilnica = "";
              if($checkCounterTombola > 0){
                $tombolaZilnica = "<div style='font-size: 16px; font-weight: 600; margin-top: 15px;'>".$zilTombolaTxt."</div>";
              }
              $tombolaFinala = "";
              if($checkCounterTombolaFin > 0){
                $tombolaFinala = "<div style='font-size: 16px; font-weight: 600; margin-top: 10px;'>".$finTombolaTxt."</div>";
              }
                print "</tbody>\n</table>\n";
                print "<div class='promo_add'> 
                        <form method='post'>
                          <div class='promo_group'><label>$intro</label><input type='text' class='promo_add_inp' name='introduceti_codul_promotional'></div> 
                          <input type='submit' value='$send' class='promo_send' name='submit_popup'>
                        </form> 
                        <a href='/user/logout' class='btn_main stock logout_btn'>".$logout."</a>
                        ".$tombolaZilnica."
                        ".$tombolaFinala."
                      </div>";
            }
        }


        /* Для менеджера филиала */
        if (in_array('authenticated', $roles) && in_array('manager_filiala', $roles) && !in_array('administrator', $roles)) {

            if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
                $name = 'Имя';
                $phone = 'Телефон';
                $action = "Подтвердить";
                $mail = 'Фамилия';
                $stats = 'Сток';
                $prem = 'Приз';
                $livrare = 'Филиал';
                $codeTxt = 'Введите код из сообщения';
            }
            if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
                $name = 'Nume';
                $phone = "Telefon";
                $action = 'Confirma';
                $mail = 'Familia';
                $stats = 'Stoc';
                $prem = 'Premiu';
                $livrare = 'Filiala';
                $codeTxt = 'Introduceți codul din mesaj';
            }
            print <<<TABLE
       <table id="table8">
       <thead>
       <tr><th>ID</th><th>$name</th><th>$mail</th><th>$phone</th><th>$prem</th><th>$livrare</th><th>$action</th></tr>
       </thead>
       <tbody>
       TABLE;
            $count = 1;
            foreach ($result as $record) {

                printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td><form method='post'><input type='hidden' value='".$record->uid."' name='active_id'> <input type='hidden' value='".$record->name."' name='form_phone'><input type='hidden' value='".$record->id."' name='prem_id'><input type='submit' name='submit_code' value='Submit' class='btn_main action search_filiala form_btn'></form></td></tr>\n", $count, $record->field_name_value,$record->field_lastname_value, $record->name, $record->premiu, $record->livrare, $record->uid);

                $count++;
            }

            print "</tbody>\n</table>\n";

            if(isset($_POST['submit_code'])){
              print "<form method='post' class='error_popup'>
                    <div class=''>".$codeTxt."</div>
                    <input type='text' placeholder='code' name='code_name'>
                    <input type='submit' style='display:flex; justify-content: center;' name='code_submit' value='Submit' onclick='closePopup()' class='btn_main action search_filiala form_btn'>
               </form>";
              $code = rand(1000, 9999);
              $_SESSION['code'] = $code;
              $_SESSION['prem_id'] = $_POST['prem_id'];
              $phone = $_POST['form_phone'];
              $params = array(

                'type' => 'SendSms' ,

                'phone' => $phone ,

                'message' => 'Codul pentru eliberarea premiului este: '.$code.' '

              );

              $resultSend = apiBulkSmsSystem( $params );
              $id = $_POST['active_id'];
              $_SESSION['id_user'] = $id;
            }

            if(isset($_POST['code_submit'])){


                if ($_POST['code_name'] == $_SESSION['code']) {
                  $getMyFilala = "SELECT * FROM user__field_filiala WHERE entity_id = '".$curr_id_for_user."' ";
                  $resultFil = $conn->query($getMyFilala);
                  $resultFil->setFetchMode(\PDO::FETCH_OBJ);
                  foreach($resultFil as $fil_res){}
                  $updateStatus = "UPDATE promo_code SET status = 3, filiala_elib = '".$fil_res->field_filiala_value."'  WHERE active = '".$_SESSION['id_user']."' AND status = 2 AND id = '".$_SESSION['prem_id']."' ";
                  if ($conn->query($updateStatus)) {
                    print "<form method='post' class='error_popup'>
                                Success
                                <input type='submit' name='code_submit' value='Submit' onclick='closePopup()' class='btn_main action search_filiala form_btn'>
                           </form>";
                  }else{
                    print "<form method='post' class='error_popup'>
                                Eroare
                                <input type='submit' name='code_submit' value='Submit' class='btn_main action search_filiala form_btn'>
                                <button onclick='closePopup()' class='btn_main action search_filiala form_btn'>Inchide</button>
                           </form>";
                  }
                }

            }
          if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {

            $search = 'Поиск';
          }
          if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {

            $search = 'Caută';
          }
            print "
                <form method='post'>
                    <input type='text' name='search' class='search_inp'>
                    <input type='submit' name='submitSearch' value='".$search."' class='btn_main action search_btn'>
                </form>
       ";
          if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
            $logout = 'Выход';
          }
          if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
            $logout = 'Ieșire';
          }
            print "<div class='admin_btns'><a href='/stock' class='btn_main stock'>" . $stats . "</a> <a href='/user/logout' class='btn_main stock logout_btn'>".$logout."</a></div>";
        }
        /*Код с выводом наград*/

        if (in_array('player', $roles) && !in_array('manager_filiala', $roles) && !in_array('administrator', $roles)) {


            $getUserID = "SELECT * FROM promo_code WHERE active != 0 ORDER BY data DESC LIMIT 1";
            $res = $conn->query($getUserID);
            $res->setFetchMode(\PDO::FETCH_OBJ);
            foreach ($res as $userID) {
            }
            if ($curr_id_for_user == $userID->active) {
              if (($promoTotal % 7) == 0 && $userID->status != 2 && $promoTotal > 0) {

                $promoSuccess = "UPDATE promo_code SET status = 1, data = NOW() WHERE promocode = '" . $userID->promocode . "' AND status = 0 ";
                if ($conn->query($promoSuccess)) {
                  $arrData  = array();
                  $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'  ";
                  $giftVal = $conn->query($getGift);
                  foreach ($giftVal as $gift => $val) {
                    $arrData[$val['sid']][$val['name']] = $val;
                    //dump($val);
                    //dump($val['value']);
                  }


                  // dump($arrData);

                  $arrShowF = array();
                  foreach ($arrData as $IDgift => $val) {
                    foreach ($val as $name => $val2) {
                      if ($name == 'categoria_de_produs' && $val2['value'] == 3) {
                        // $val['title'] = $val[''];
                        $arrShowF[[$IDgift]['filiala']['value']][] = array('image' =>$arrData[$IDgift]['gift_image']['value'],'active' =>$arrData[$IDgift]['active']['value'],'name' => $arrData[$IDgift]['premiu']['value'], 'filiala' => $arrData[$IDgift]['filiala']['value'], 'id' => $IDgift);
                      }
                    }
                  }
                  $arr = [];
                  $arrFil = [];
                  foreach ($arrShowF as $filiala => $arrShow) {
                    $option = '';
                    $option2 = '';
                    foreach ($arrShow as $ft => $val) {
                      if($val['active'] == '1'){
                        $arr[] = $val['name'];
                        $arrFil[] = $val['filiala'];
                      }
                      //dump($arrShow);
                    }
                    function isUnique($array, $key, $val)
                    {
                      foreach ($array as $item) {
                        if ($item[$key] === $val) {
                          return false;
                        }
                      }
                      return true;
                    }

                    // Отфильтрованный массив с уникальными элементами по полю "name"
                    $filteredArray = [];
                    foreach ($arrShow as $value) {
                      if($value['active'] == '1'){
                        if (isUnique($filteredArray, "name", $value["name"])) {
                          $filteredArray[] = $value;
                        }
                      }
                    }
                    foreach ($filteredArray as $filteredVal) {
                      $file_storage = \Drupal::service('entity_type.manager')->getStorage('file');
                      $file = $file_storage->load($filteredVal['image']);
                      if ($file) {
                        $file_path = $file->getFileUri(); // Получение пути к файлу.
                        $file_name = $file->getFilename(); // Получение имени файла.
                      }
                      $string = str_replace("public://", "", $file_path);
                      $arrImg .= "<img src='/sites/default/files/" . $string . "'>";
                    }

                    $Filiala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala'  ";
                    $filVal = $conn->query($Filiala);
                    foreach ($filVal as $arrValFil) {
                      $option2 .= " <option>" . $arrValFil['value'] . "</option> ";
                    }
                    $arrUnique = array_unique($arr);
                    foreach ($arrUnique as $arrVal) {
                      $option .= " <option>" . $arrVal . "</option> ";
                    }

                  }
                  //dump($arrUnique);
                  //dump($arrShow);
                  if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
                    $label = "Выберите приз из списка ниже";
                    $confirm = "Подтвердить";
                  }
                  if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
                    $label = "Alege premiul din lista de mai jos";
                    $confirm = "Alege";
                  }
                  print "<form method='POST' class='use-ajax webform-dialog webform-dialog-narrow popup_gift' data-dialog-type='modal'>
                                                                    ".$label."
                                                                    <div class='popup_images'>
                                                                        " . $arrImg . "
                                                                    </div>
                                                                    <div><select name='premiu'>
                                                                        " . $option . "
                                                                    </select>
                                                                    <select name='filial'>
                                                                        " . $option2 . "
                                                                    </select>
                                                                    </div>
                                                                    <input type='submit' class='btn_main action' name='submitGift' value='".$confirm."'>

                                                                </form>
                                                                ";
                }
                if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
                  $txt1 = "Вы уверены в выборе приза";
                  $txt2 = "и получении его в филиале";
                }
                if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
                  $txt1 = "Sunteți sigur în alegerea premiului";
                  $txt2 = "și ridicarea la filiala";
                }
                if (isset($_POST['submitGift'])) {
                  $selectedPremiu = ''; // Задайте начальное значение выбранного приза

                  if (isset($_POST['premiu'])) {
                    $selectedPremiu = $_POST['premiu'];
                  }
                  print "<form method='POST' class='popup_gift'>
                                             <div class='center'>".$txt1. " ".$_POST['premiu']." ". $txt2 ." ".$_POST['filial']."</div>
                                             <div class='popup_gift_btns' style='display: flex;justify-content: center; text-align: center'>
                                             <input type='submit' name='acceptPrem' class='btn_main action' value='Da' style='margin-right: 5px;'>
                                             <input type='submit' name='ignorePrem' class='btn_main action' value='Nu'>
                                              </div>
                                         </form>
                                         ";
                  $updatePromo = "UPDATE promo_code SET premiu = '" . $_POST['premiu'] . "', livrare = '" . $_POST['filial'] . "' WHERE promocode = '" . $userID->promocode . "' AND status = 1 ";
                  if ($conn->query($updatePromo)) {

                  }

                }
                if(isset($_POST['acceptPrem'])){
                  $updatePromo = "UPDATE promo_code SET status = 2 WHERE active = '" . $curr_id_for_user . "' AND status=1";

                  if ($conn->query($updatePromo)) {

                  }
                }
                if(isset($_POST['ignorePrem'])){
                  header("Location: /account");
                }

                }
              else if($total >= 7 && $total % 7 != 0 && $userID->status != 2){
                                    $checkPromo = "SELECT * FROM promo_code WHERE status = 1 AND active = '" . $curr_id_for_user . "'";
                                    $checkPromoItem = $conn->query($checkPromo);
                                    $checkPromoItem->setFetchMode(\PDO::FETCH_OBJ);
                                    $checkCounter = 0;
                                    foreach ($checkPromoItem as $checkItem) {
                                        $checkCounter++;
                                    }
                                    if ($checkCounter == 1) {
                                        $arrData  = array();
                                                                $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'  ";
                                                                $giftVal = $conn->query($getGift);
                                                                foreach ($giftVal as $gift => $val) {
                                                                    $arrData[$val['sid']][$val['name']] = $val;
                                                                    //dump($val);
                                                                    //dump($val['value']);
                                                                }


                                                                // dump($arrData);

                                                                $arrShowF = array();
                                                                foreach ($arrData as $IDgift => $val) {
                                                                    foreach ($val as $name => $val2) {
                                                                        if ($name == 'categoria_de_produs' && $val2['value'] == 3) {
                                                                            // $val['title'] = $val[''];
                                                                            $arrShowF[[$IDgift]['filiala']['value']][] = array('image' =>$arrData[$IDgift]['gift_image']['value'],'name' => $arrData[$IDgift]['premiu']['value'], 'filiala' => $arrData[$IDgift]['filiala']['value'], 'id' => $IDgift);
                                                                        }
                                                                    }
                                                                }
                                                                $arr = [];
                                                                $arrFil = [];
                                                                foreach ($arrShowF as $filiala => $arrShow) {


                                                                    $option = '';
                                                                    $option2 = '';
                                                                    foreach ($arrShow as $ft => $val) {

                                                                      if($val['active'] == '1') {
                                                                        $arr[] = $val['name'];
                                                                        $arrFil[] = $val['filiala'];
                                                                      }
                                                                        //dump($arrShow);
                                                                    }
                                                                    function isUnique($array, $key, $val)
                                                                    {
                                                                        foreach ($array as $item) {
                                                                            if ($item[$key] === $val) {
                                                                                return false;
                                                                            }
                                                                        }
                                                                        return true;
                                                                    }

                                                                    // Отфильтрованный массив с уникальными элементами по полю "name"
                                                                    $filteredArray = [];
                                                                    foreach ($arrShow as $value) {
                                                                      if($value['active'] == '1'){
                                                                        if (isUnique($filteredArray, "name", $value["name"])) {
                                                                          $filteredArray[] = $value;
                                                                        }
                                                                      }
                                                                    }
                                                                    foreach ($filteredArray as $filteredVal) {
                                                                        $file_storage = \Drupal::service('entity_type.manager')->getStorage('file');
                                                                        $file = $file_storage->load($filteredVal['image']);
                                                                        if ($file) {
                                                                            $file_path = $file->getFileUri(); // Получение пути к файлу.
                                                                            $file_name = $file->getFilename(); // Получение имени файла.

                                                                        }
                                                                        $string = str_replace("public://", "", $file_path);
                                                                        $arrImg .= "<img src='/sites/default/files/" . $string . "'>";
                                                                    }
                                                                  $Filiala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala'  ";
                                                                  $filVal = $conn->query($Filiala);
                                                                  foreach ($filVal as $arrValFil) {
                                                                    $option2 .= " <option>" . $arrValFil['value'] . "</option> ";
                                                                  }
                                                                    $arrUnique = array_unique($arr);
                                                                    foreach ($arrUnique as $arrVal) {
                                                                        $option .= " <option>" . $arrVal . "</option> ";
                                                                    }
                                                                }
                                      if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
                                        $label = "Выберите приз из списка ниже";
                                        $confirm = "Подтвердить";
                                      }
                                      if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
                                        $label = "Alege premiul din lista de mai jos";
                                        $confirm = "Alege";
                                      }

                        print "<form method='POST' class='use-ajax webform-dialog webform-dialog-narrow popup_gift' data-dialog-type='modal'>
                                                ".$label."
                                                <div class='popup_images'>
                                                    " . $arrImg . "
                                                </div>
                                                <div><select name='premiu'>
                                                    " . $option . "
                                                </select>
                                                <select name='filial'>
                                                    " . $option2 . "
                                                </select>
                                                </div>
                                                <input type='submit' class='btn_main action' name='submitGift' value='".$confirm."'>

                                            </form>
                                            ";

                                      if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
                                        $txt1 = "Вы уверены в выборе приза";
                                        $txt2 = "и получении его в филиале";
                                      }
                                      if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
                                        $txt1 = "Sunteți sigur în alegerea premiului";
                                        $txt2 = "și ridicarea la filiala";
                                      }
                                      if (isset($_POST['submitGift'])) {
                                        $selectedPremiu = ''; // Задайте начальное значение выбранного приза

                                        if (isset($_POST['premiu'])) {
                                          $selectedPremiu = $_POST['premiu'];
                                        }
                                        print "<form method='POST' class='popup_gift'>
                                             <div class='center'>".$txt1. " ".$_POST['premiu']." ". $txt2 ." ".$_POST['filial']."</div>
                                             <div class='popup_gift_btns' style='display: flex;justify-content: center; text-align: center'>
                                             <input type='submit' name='acceptPrem' class='btn_main action' value='Da' style='margin-right: 5px;'>
                                             <input type='submit' name='ignorePrem' class='btn_main action' value='Nu'>
                                              </div>
                                         </form>
                                         ";
                                        $updatePromo = "UPDATE promo_code SET premiu = '" . $_POST['premiu'] . "', livrare = '" . $_POST['filial'] . "' WHERE promocode = '" . $userID->promocode . "' AND status = 1 ";
                                        if ($conn->query($updatePromo)) {

                                        }

                                      }
                                      if(isset($_POST['acceptPrem'])){
                                        $updatePromo = "UPDATE promo_code SET status = 2 WHERE active = '" . $curr_id_for_user . "' AND status=1";

                                        if ($conn->query($updatePromo)) {

                                        }
                                      }
                                      if(isset($_POST['ignorePrem'])){
                                        header("Location: /account");
                                      }
                                    }
                } else {
                    if (isset($_POST['introduceti_codul_promotional']) && $total % 30 != 0 && $total % 15 != 0 && $total % 7 != 0) {
                        print "<form method='post' class='nonactive_user'>
                        <div class=''>".$codeRepeat."</div>
                        <input type='submit' style='margin:0 auto; display:flex; justify-content: center;' value='Submit' class='btn_main action search_filiala form_btn'>
                   </form>";

                    }
                }

            }
          if ($total >= 10 && $total % 10 == 0 && $userID->status != 2) {

            $checkPromo = "SELECT * FROM promo_code WHERE status = 10 AND active = '".$curr_id_for_user."' ";
            $checkPromoItem = $conn->query($checkPromo);
            $checkPromoItem->setFetchMode(\PDO::FETCH_OBJ);
            $checkCounter = 0;
            foreach ($checkPromoItem as $checkItem) {
              $checkCounter++;
            }
            if ($checkCounter == 0 || $checkCounter > 0) {
              $promoSuccess = "UPDATE promo_code SET status = 10, data = NOW() WHERE promocode = '" . $userID->promocode . "' AND status = 0 ";
              if ($conn->query($promoSuccess)) {
                $arrData  = array();
                $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'  ";
                $giftVal = $conn->query($getGift);
                foreach ($giftVal as $gift => $val) {
                  $arrData[$val['sid']][$val['name']] = $val;
                  //dump($val);
                  //dump($val['value']);
                }


                // dump($arrData);

                $arrShowF = array();
                foreach ($arrData as $IDgift => $val) {
                  foreach ($val as $name => $val2) {
                    if ($name == 'categoria_de_produs' && $val2['value'] == 2 || $name == 'categoria_de_produs' && $val2['value'] == 3) {
                      // $val['title'] = $val[''];
                      $arrShowF[[$IDgift]['filiala']['value']][] = array('image' => $arrData[$IDgift]['gift_image']['value'],'active' => $arrData[$IDgift]['active']['value'], 'name' => $arrData[$IDgift]['premiu']['value'], 'filiala' => $arrData[$IDgift]['filiala']['value'], 'id' => $IDgift);
                    }
                  }
                }
                //dump($arrShowF);
                $arr = [];
                $arrFil = [];
                $arrIMG = [];
                foreach ($arrShowF as $filiala => $arrShow) {



                  $option = '';
                  $option2 = '';
                  foreach ($arrShow as $ft => $val) {
                    if($val['active'] == '1') {
                      $arr[] = $val['name'];
                      $arrFil[] = $val['filiala'];
                    }
                  }
                  $Filiala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala'  ";
                  $filVal = $conn->query($Filiala);
                  foreach ($filVal as $arrValFil) {
                    $option2 .= " <option>" . $arrValFil['value'] . "</option> ";
                  }
                  function isUnique($array, $key, $value)
                  {
                    foreach ($array as $item) {
                      if ($item[$key] === $value) {
                        return false;
                      }
                    }
                    return true;
                  }

                  // Отфильтрованный массив с уникальными элементами по полю "name"
                  $filteredArray = [];
                  foreach ($arrShow as $value) {
                    if($value['active'] == '1') {
                      if (isUnique($filteredArray, "name", $value["name"])) {
                        $filteredArray[] = $value;
                      }
                    }

                  }
                  foreach ($filteredArray as $filteredVal) {
                    $file_storage = \Drupal::service('entity_type.manager')->getStorage('file');
                    $file = $file_storage->load($filteredVal['image']);
                    if ($file) {
                      $file_path = $file->getFileUri(); // Получение пути к файлу.
                      $file_name = $file->getFilename(); // Получение имени файла.

                    }
                    $string = str_replace("public://", "", $file_path);
                    $arrImg .= "<img src='/sites/default/files/" . $string . "'>";
                  }

                  $arrUnique = array_unique($arr);

                  foreach ($arrUnique as $arrVal) {
                    $option .= " <option>" . $arrVal . "</option> ";
                  }
                  //dump($arrUnique);
                  if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
                    $label = "Выберите приз из списка ниже";
                    $confirm = "Подтвердить";
                  }
                  if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
                    $label = "Alege premiul din lista de mai jos";
                    $confirm = "Alege";
                  }
                  if($userID->status != 2){
                  print "<form method='POST' class='popup_gift'>
".$label."
                                                                                                                                <div class='popup_images'>
                                                                                                                                    " . $arrImg . "
                                                                                                                                </div>
                                                                                                                                   <select name='premiu'>

                                                                                                                                       " . $option . "
                                                                                                                                   </select>
                                                                                                                                   <select name='filial'>

                                                                                                                                       " . $option2 . "
                                                                                                                                   </select>
                                                                                                                                   <input type='submit' class='btn_main action' name='submitGift' value='".$confirm."'>

                                                                                                                               </form>
                                                                                                                               ";
                  }
                }
                //dump($arrShow);
              }


            }
            if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
              $txt1 = "Вы уверены в выборе приза";
              $txt2 = "и получении его в филиале";
            }
            if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
              $txt1 = "Sunteți sigur în alegerea premiului";
              $txt2 = "și ridicarea la filiala";
            }
            if (isset($_POST['submitGift'])) {

              print "<form method='POST' class='popup_gift'>
                                             <div class='center'>".$txt1. " ".$_POST['premiu']." ". $txt2 ." ".$_POST['filial']."</div>
                                             <div class='popup_gift_btns' style='display: flex;justify-content: center; text-align: center'>
                                             <input type='submit' name='acceptPrem' class='btn_main action' value='Da' style='margin-right: 5px;'>
                                             <input type='submit' name='ignorePrem' class='btn_main action' value='Nu'>
                                              </div>
                                         </form>
                                         ";
              $updatePromo = "UPDATE promo_code SET premiu = '" . $_POST['premiu'] . "', livrare = '" . $_POST['filial'] . "' WHERE promocode = '" . $userID->promocode . "' AND status = 10 ";
              if ($conn->query($updatePromo)) {

              }

            }
            if(isset($_POST['acceptPrem'])){
              $updatePromo = "UPDATE promo_code SET status = 2 WHERE active = '" . $curr_id_for_user . "' AND status=10";

              if ($conn->query($updatePromo)) {

              }
            }
            if(isset($_POST['ignorePrem'])){
              header("Location: /account");
            }
          }
          else if ($total > 10 && $total % 7 != 0  && $userID->status != 2) {
            $checkPromo = "SELECT * FROM promo_code WHERE status = 10 AND active = '" . $curr_id_for_user . "'";
            $checkPromoItem = $conn->query($checkPromo);
            $checkPromoItem->setFetchMode(\PDO::FETCH_OBJ);
            $checkCounter = 0;
            foreach ($checkPromoItem as $checkItem) {
              $checkCounter++;
            }
            if ($checkCounter == 1) {
              $arrData  = array();
              $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'  ";
              $giftVal = $conn->query($getGift);
              foreach ($giftVal as $gift => $val) {
                $arrData[$val['sid']][$val['name']] = $val;
                //dump($val);
                //dump($val['value']);
              }


              // dump($arrData);

              $arrShowF = array();
              foreach ($arrData as $IDgift => $val) {
                foreach ($val as $name => $val2) {
                  if ($name == 'categoria_de_produs' && $val2['value'] == 2 || $name == 'categoria_de_produs' && $val2['value'] == 3) {
                    // $val['title'] = $val[''];
                    $arrShowF[[$IDgift]['filiala']['value']][] = array('image' => $arrData[$IDgift]['gift_image']['value'], 'name' => $arrData[$IDgift]['premiu']['value'],'active' => $arrData[$IDgift]['active']['value'], 'filiala' => $arrData[$IDgift]['filiala']['value'], 'id' => $IDgift);
                  }
                }
              }
              //dump($arrShowF);
              $arr = [];
              $arrFil = [];
              foreach ($arrShowF as $filiala => $arrShow) {

                $option = '';
                $option2 = '';
                foreach ($arrShow as $ft => $val) {
                  if($val['active'] == '1') {
                    $arr[] = $val['name'];
                    $arrFil[] = $val['filiala'];
                  }

                }
                $Filiala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala'  ";
                $filVal = $conn->query($Filiala);
                foreach ($filVal as $arrValFil) {
                  $option2 .= " <option>" . $arrValFil['value'] . "</option> ";
                }
                function isUnique($array, $key, $value)
                {
                  foreach ($array as $item) {
                    if ($item[$key] === $value) {
                      return false;
                    }
                  }
                  return true;
                }

                // Отфильтрованный массив с уникальными элементами по полю "name"
                $filteredArray = [];
                foreach ($arrShow as $value) {
                  if($value['active'] == '1') {
                    if (isUnique($filteredArray, "name", $value["name"])) {
                      $filteredArray[] = $value;
                    }
                  }
                }
                foreach ($filteredArray as $filteredVal) {
                  $file_storage = \Drupal::service('entity_type.manager')->getStorage('file');
                  $file = $file_storage->load($filteredVal['image']);
                  if ($file) {
                    $file_path = $file->getFileUri(); // Получение пути к файлу.
                    $file_name = $file->getFilename(); // Получение имени файла.

                  }
                  $string = str_replace("public://", "", $file_path);
                  $arrImg .= "<img src='/sites/default/files/" . $string . "'>";
                }
                $arrUnique = array_unique($arr);

                foreach ($arrUnique as $arrVal) {
                  $option .= " <option>" . $arrVal . "</option> ";
                }
                //dump($arrUnique);
                if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
                  $label = "Выберите приз из списка ниже";
                  $confirm = "Подтвердить";
                }
                if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
                  $label = "Alege premiul din lista de mai jos";
                  $confirm = "Alege";
                }
                if($userID->status != 2) {
                  print "<form method='POST' class='use-ajax webform-dialog webform-dialog-narrow popup_gift' data-dialog-type='modal'>
                                                                                    " . $label . "
                                                                                   <div class='popup_images'>
                                                                                    " . $arrImg . "
                                                                                   </div>

                                                                                   <select name='premiu'>

                                                                                       " . $option . "
                                                                                   </select>
                                                                                   <select name='filial'>

                                                                                       " . $option2 . "
                                                                                   </select>
                                                                                   <input type='submit' class='btn_main action' name='submitGift' value='" . $confirm . "'>

                                                                               </form>
                                                                               ";
                }
              }
              //dump($arrShow);
              if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
                $txt1 = "Вы уверены в выборе приза";
                $txt2 = "и получении его в филиале";
              }
              if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
                $txt1 = "Sunteți sigur în alegerea premiului";
                $txt2 = "și ridicarea la filiala";
              }
              if (isset($_POST['submitGift'])) {
                $selectedPremiu = ''; // Задайте начальное значение выбранного приза

                if (isset($_POST['premiu'])) {
                  $selectedPremiu = $_POST['premiu'];
                }
                print "<form method='POST' class='popup_gift'>
                                             <div class='center'>".$txt1. " ".$_POST['premiu']." ". $txt2 ." ".$_POST['filial']."</div>
                                             <div class='popup_gift_btns' style='display: flex;justify-content: center; text-align: center'>
                                             <input type='submit' name='acceptPrem' class='btn_main action' value='Da' style='margin-right: 5px;'>
                                             <input type='submit' name='ignorePrem' class='btn_main action' value='Nu'>
                                              </div>
                                         </form>
                                         ";
                $updatePromo = "UPDATE promo_code SET premiu = '" . $_POST['premiu'] . "', livrare = '" . $_POST['filial'] . "' WHERE promocode = '" . $userID->promocode . "' AND status = 10 ";
                if ($conn->query($updatePromo)) {

                }

              }
              if(isset($_POST['acceptPrem'])){
                $updatePromo = "UPDATE promo_code SET status = 2 WHERE active = '" . $curr_id_for_user . "' AND status=10";

                if ($conn->query($updatePromo)) {

                }
              }
              if(isset($_POST['ignorePrem'])){
                header("Location: /account");
              }
            }
          }
          if ($total > 0 && $total % 15 == 0 && $userID->tombola == 0) {
            $tombolaSuccess = "UPDATE promo_code SET tombola = 1,status = 0, data = NOW() WHERE promocode = '" . $userID->promocode . "' AND tombola = 0 ";
            if ($conn->query($tombolaSuccess)) {
              print "<form method='POST' class='use-ajax webform-dialog webform-dialog-narrow popup_final' data-dialog-type='modal'>
                                        <div  class='center'>Felicitări, ați fost ales participant la tombola zilnică!</div>
                                        <div class='btn_main action closePopupTombola'>Închide</div>
                                    </form>
                                    ";
            }
          }else if($total >= 15 && $userID->tombola == 2){
            $promoSuccess = "UPDATE promo_code SET status = 1, data = NOW() WHERE promocode = '" . $userID->promocode . "' AND status = 0 ";
            if ($conn->query($promoSuccess)) {
              $arrData  = array();
              $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'  ";
              $giftVal = $conn->query($getGift);
              foreach ($giftVal as $gift => $val) {
                $arrData[$val['sid']][$val['name']] = $val;
                //dump($val);
                //dump($val['value']);
              }


              // dump($arrData);

              $arrShowF = array();
              foreach ($arrData as $IDgift => $val) {
                foreach ($val as $name => $val2) {
                  if ($name == 'categoria_de_produs' && $val2['value'] == 1) {
                    // $val['title'] = $val[''];
                    $arrShowF[[$IDgift]['filiala']['value']][] = array('image' =>$arrData[$IDgift]['gift_image']['value'],'active' =>$arrData[$IDgift]['active']['value'],'name' => $arrData[$IDgift]['premiu']['value'], 'filiala' => $arrData[$IDgift]['filiala']['value'], 'id' => $IDgift);
                  }
                }
              }
              $arr = [];
              $arrFil = [];
              foreach ($arrShowF as $filiala => $arrShow) {
                $option = '';
                $option2 = '';
                foreach ($arrShow as $ft => $val) {
                  if($val['active'] == '1'){
                    $arr[] = $val['name'];
                    $arrFil[] = $val['filiala'];
                  }
                  //dump($arrShow);
                }
                function isUnique($array, $key, $val)
                {
                  foreach ($array as $item) {
                    if ($item[$key] === $val) {
                      return false;
                    }
                  }
                  return true;
                }

                // Отфильтрованный массив с уникальными элементами по полю "name"
                $filteredArray = [];
                foreach ($arrShow as $value) {
                  if($value['active'] == '1'){
                    if (isUnique($filteredArray, "name", $value["name"])) {
                      $filteredArray[] = $value;
                    }
                  }
                }
                foreach ($filteredArray as $filteredVal) {
                  $file_storage = \Drupal::service('entity_type.manager')->getStorage('file');
                  $file = $file_storage->load($filteredVal['image']);
                  if ($file) {
                    $file_path = $file->getFileUri(); // Получение пути к файлу.
                    $file_name = $file->getFilename(); // Получение имени файла.
                  }
                  $string = str_replace("public://", "", $file_path);
                  $arrImg .= "<img src='/sites/default/files/" . $string . "'>";
                }

                $Filiala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala'  ";
                $filVal = $conn->query($Filiala);
                foreach ($filVal as $arrValFil) {
                  $option2 .= " <option>" . $arrValFil['value'] . "</option> ";
                }
                $arrUnique = array_unique($arr);
                foreach ($arrUnique as $arrVal) {
                  $option .= " <option>" . $arrVal . "</option> ";
                }

              }
              //dump($arrUnique);
              //dump($arrShow);
              if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
                $label = "Выберите приз из списка ниже";
                $confirm = "Подтвердить";
              }
              if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
                $label = "Alege premiul din lista de mai jos";
                $confirm = "Alege";
              }
              print "<form method='POST' class='use-ajax webform-dialog webform-dialog-narrow popup_gift' data-dialog-type='modal'>
                                                                    ".$label."
                                                                    <div class='popup_images'>
                                                                        " . $arrImg . "
                                                                    </div>
                                                                    <div><select name='premiu'>
                                                                        " . $option . "
                                                                    </select>
                                                                    <select name='filial'>
                                                                        " . $option2 . "
                                                                    </select>
                                                                    </div>
                                                                    <input type='submit' class='btn_main action' name='submitGift' value='".$confirm."'>

                                                                </form>
                                                                ";
            }
            if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
              $txt1 = "Вы уверены в выборе приза";
              $txt2 = "и получении его в филиале";
            }
            if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
              $txt1 = "Sunteți sigur în alegerea premiului";
              $txt2 = "și ridicarea la filiala";
            }
            if (isset($_POST['submitGift'])) {
              $selectedPremiu = ''; // Задайте начальное значение выбранного приза

              if (isset($_POST['premiu'])) {
                $selectedPremiu = $_POST['premiu'];
              }
              print "<form method='POST' class='popup_gift'>
                                             <div class='center'>".$txt1. " ".$_POST['premiu']." ". $txt2 ." ".$_POST['filial']."</div>
                                             <div class='popup_gift_btns' style='display: flex;justify-content: center; text-align: center'>
                                             <input type='submit' name='acceptPrem' class='btn_main action' value='Da' style='margin-right: 5px;'>
                                             <input type='submit' name='ignorePrem' class='btn_main action' value='Nu'>
                                              </div>
                                         </form>
                                         ";
              $updatePromo = "UPDATE promo_code SET premiu = '" . $_POST['premiu'] . "', livrare = '" . $_POST['filial'] . "' WHERE promocode = '" . $userID->promocode . "' AND status = 1 ";
              if ($conn->query($updatePromo)) {

              }

            }
            if(isset($_POST['acceptPrem'])){
              $updatePromo = "UPDATE promo_code SET status = 2 WHERE active = '" . $curr_id_for_user . "' AND status=1";

              if ($conn->query($updatePromo)) {

              }
            }
            if(isset($_POST['ignorePrem'])){
              header("Location: /account");
            }
          }
          if ($total > 0 && $total % 30 == 0 && $userID->final == 0) {
            $tombolaSuccess = "UPDATE promo_code SET final = 1, data = NOW() WHERE promocode = '" . $userID->promocode . "' AND final = 0 ";
            if ($conn->query($tombolaSuccess)) {
              print "<form method='POST' class='use-ajax webform-dialog webform-dialog-narrow popup_final' data-dialog-type='modal'>
                                       <div class='center'>Felicitări, ați fost ales participant la tombola finală!</div>
                                       <div class='btn_main action closePopupTombola'>Închide</div>
                                   </form>
                                   ";
            }
          }
        }
    }
}

/*
Страница вывода стока
*/

function nescafe_preprocess_region__stock($page)
{

    $roles = \Drupal::currentUser()->getRoles();
    $curr_id_for_user = \Drupal::currentUser()->id();


    $config = new Config();
    $credentials = $config->credentials('database');
    $dsn = sprintf('mysql:host=%s;port=%d;dbname=%s', $credentials['host'], $credentials['port'], $credentials['path']);
    $conn = new \PDO($dsn, $credentials['username'], $credentials['password'], [
        \PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION,
        \PDO::MYSQL_ATTR_USE_BUFFERED_QUERY => TRUE,
        \PDO::MYSQL_ATTR_FOUND_ROWS => TRUE,
    ]);
    /*
    Для менеджера
    */
    if (in_array('authenticated', $roles) && in_array('manager_filiala', $roles) && !in_array('administrator', $roles)) {
        $arrData  = array();
        $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'  ";
        $giftVal = $conn->query($getGift);
        foreach ($giftVal as $gift => $val) {
            $arrData[$val['sid']][$val['name']] = $val;
            //dump($val);
            //dump($val['value']);
        }

        $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3";
        $elib = $conn->query($elibSQL);
        $countElib = 0;
        foreach ($elib as $elibVal) {
            $countElib++;
        }

        $filialSQL = "SELECT * FROM user__field_filiala WHERE revision_id = '" . $curr_id_for_user . "' ";
        $fil = $conn->query($filialSQL);
        foreach ($fil as $filValue) {
        }


        $arrShowF = array();
        foreach ($arrData as $IDgift => $val) {
            foreach ($val as $name => $val2) {


                    if (($name == 'categoria_de_produs' && $val2['value'] == 3)) {
                        //$arrShowF[[$IDgift]['filiala']['value']][] = array( 'name3' => $arrData[$IDgift]['premiu']['value'] ,'filiala3' => $arrData[$IDgift]['filiala']['value'],'stock3' => $arrData[$IDgift]['stock']['value'],'suplimentar3' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
                        $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['name3'] = $arrData[$IDgift]['premiu']['value'];
                        $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['filiala3'] = $arrData[$IDgift]['filiala']['value'];
                        $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['stock3'] +=  $arrData[$IDgift]['stock']['value'];
                        $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['suplimentar3'] +=  $arrData[$IDgift]['suplimentar']['value'];
                        $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['id'] +=  $IDgift;
                    }
                    if (($name == 'categoria_de_produs' && $val2['value'] == 2)) {
                        // $val['title'] = $val[''];
                        //$arrShowF2[[$IDgift]['filiala']['value']][] = array( 'name2' => $arrData[$IDgift]['premiu']['value'] ,'filiala2' => $arrData[$IDgift]['filiala']['value'],'stock2' => $arrData[$IDgift]['stock']['value'],'suplimentar2' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
                        $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['name2'] = $arrData[$IDgift]['premiu']['value'];
                        $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['filiala2'] = $arrData[$IDgift]['filiala']['value'];
                        $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['stock2'] +=  $arrData[$IDgift]['stock']['value'];
                        $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['suplimentar2'] +=  $arrData[$IDgift]['suplimentar']['value'];
                        $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['id'] +=  $IDgift;
                    }
                    if (($name == 'categoria_de_produs' && $val2['value'] == 1)) {
                        // $val['title'] = $val[''];
                        //$arrShowF1[[$IDgift]['filiala']['value']][] = array( 'name1' => $arrData[$IDgift]['premiu']['value'] ,'filiala1' => $arrData[$IDgift]['filiala']['value'],'stock1' => $arrData[$IDgift]['stock']['value'],'suplimentar1' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
                        $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['name1'] = $arrData[$IDgift]['premiu']['value'];
                        $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['filiala1'] = $arrData[$IDgift]['filiala']['value'];
                        $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['stock1'] +=  $arrData[$IDgift]['stock']['value'];
                        $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['suplimentar1'] +=  $arrData[$IDgift]['suplimentar']['value'];
                        $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']]['id'] +=  $IDgift;
                    }

            }
        }
        $arr = [];
        if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
            $solicitate = 'Запрошено';
            $stock_init = 'Начальный сток';
            $supliment = 'Дополнение';
            $stoc_dispon = 'Наличие в стоке';
            $eliberate = 'Выпуск';
            $stoc_final = 'Финальный сток';
            $grad = 'Класс';
            $premiu = 'Приз';
            $premFil = 'Филиал';
        }
        if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
            $solicitate = 'Solicitate';
            $stock_init = 'Stoc initial';
            $supliment = 'Suplimentar';
            $stoc_dispon = 'Stoc disponibil';
            $eliberate = 'Eliberate';
            $stoc_final = 'Stoc final';
            $grad = 'Gradul';
            $premiu = 'Premiu';
            $premFil = 'Filiala';
        }

        print <<<TABLE
            <table id="table8">
            <thead>
            <tr><th>$grad 3</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
            </thead>
            <tbody>
            TABLE;
        $count = 1;
      foreach ($arrShowF as $filiala => $arrShow) {
        $getStock = "SELECT * FROM stock WHERE filiala = '".$filValue['field_filiala_value']."'";
        $stockInfo = $conn->query($getStock);

        $combinedArray = array();
        foreach ($stockInfo as $info) {
          $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

          if (!isset($combinedArray[$premiuFiliala])) {
            $combinedArray[$premiuFiliala] = array(
              'initial' => 0,
              'suplimentar' => 0,
              'data' => ''
            );
          }

          $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
          $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
          $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
          $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
          $combinedArray[$premiuFiliala]['data'] = $info['data'];
        }
        $stockInit = 0;

        $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $filValue['field_filiala_value'] . "' AND premiu = '" . $arrShow['name3'] . "'";
        $sol = $conn->query($solicitSQL);
        $solicit = 0;
        foreach ($sol as $solVal) {
          $solicit++;
        }
        $supl = 0;
        $initStock = 0;
        foreach ($combinedArray as $arrKey => $arrValue){
          if($arrValue['premiu'] == $arrShow['name3'] && $arrValue['filiala'] == $filValue['field_filiala_value']){
            $supl = $arrValue['suplimentar'];
            $initStock = $arrValue['initial'];
          }
        }
        $stockDisp = $initStock + $supl;

        $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3";
        $elib = $conn->query($elibSQL);
        $countElib = 0;
        foreach ($elib as $elibVal) {
          if($elibVal['premiu'] == $arrShow['name3']) {
            $countElib++;
          }
        }
        $stockFinal = $stockDisp - $countElib;
        printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name3'], $filValue['field_filiala_value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

        $count++;
      }

        print "</tbody>\n</table>\n";

        print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 2</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      foreach ($arrShowF2 as $filiala => $arrShow) {
        $getStock = "SELECT * FROM stock WHERE filiala = '".$filValue['field_filiala_value']."'";
        $stockInfo = $conn->query($getStock);

        $combinedArray = array();
        foreach ($stockInfo as $info) {
          $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

          if (!isset($combinedArray[$premiuFiliala])) {
            $combinedArray[$premiuFiliala] = array(
              'initial' => 0,
              'suplimentar' => 0,
              'data' => ''
            );
          }

          $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
          $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
          $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
          $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
          $combinedArray[$premiuFiliala]['data'] = $info['data'];
        }
        $stockInit = 0;

        $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $filValue['field_filiala_value'] . "' AND premiu = '" . $arrShow['name2'] . "'";
        $sol = $conn->query($solicitSQL);
        $solicit = 0;
        foreach ($sol as $solVal) {
          $solicit++;
        }
        $supl = 0;
        $initStock = 0;
        foreach ($combinedArray as $arrKey => $arrValue){
          if($arrValue['premiu'] == $arrShow['name2'] && $arrValue['filiala'] == $filValue['field_filiala_value']){
            $supl = $arrValue['suplimentar'];
            $initStock = $arrValue['initial'];
          }
        }
        $stockDisp = $initStock + $supl;

        $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3";
        $elib = $conn->query($elibSQL);
        $countElib = 0;
        foreach ($elib as $elibVal) {
          if($elibVal['premiu'] == $arrShow['name2']) {
            $countElib++;
          }
        }
        $stockFinal = $stockDisp - $countElib;
        printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name2'], $filValue['field_filiala_value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

        $count++;
        }

        print "</tbody>\n</table>\n";

        print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 1</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      foreach ($arrShowF1 as $filiala => $arrShow) {
        $getStock = "SELECT * FROM stock WHERE filiala = '".$filValue['field_filiala_value']."' ";
        $stockInfo = $conn->query($getStock);

        $combinedArray = array();
        foreach ($stockInfo as $info) {
          $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

          if (!isset($combinedArray[$premiuFiliala])) {
            $combinedArray[$premiuFiliala] = array(
              'initial' => 0,
              'suplimentar' => 0,
              'data' => ''
            );
          }

          $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
          $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
          $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
          $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
          $combinedArray[$premiuFiliala]['data'] = $info['data'];
        }
        $stockInit = 0;

        $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $filValue['field_filiala_value'] . "' AND premiu = '" . $arrShow['name1'] . "'";
        $sol = $conn->query($solicitSQL);
        $solicit = 0;
        foreach ($sol as $solVal) {
          $solicit++;
        }
        $supl = 0;
        $initStock = 0;
        foreach ($combinedArray as $arrKey => $arrValue){
          if($arrValue['premiu'] == $arrShow['name1'] && $arrValue['filiala'] == $filValue['field_filiala_value']){
            $supl = $arrValue['suplimentar'];
            $initStock = $arrValue['initial'];
          }
        }
        $stockDisp = $initStock + $supl;

        $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3";
        $elib = $conn->query($elibSQL);
        $countElib = 0;
        foreach ($elib as $elibVal) {
          if($elibVal['premiu'] == $arrShow['name1']) {
            $countElib++;
          }
        }
        $stockFinal = $stockDisp - $countElib;
        printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name1'], $filValue['field_filiala_value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

        $count++;
        }

        print "</tbody>\n</table>\n";
    }

    /*
    для администратора
 */

    if (in_array('authenticated', $roles) && !in_array('manager_filiala', $roles) && in_array('administrator', $roles)) {
        $arrData  = array();
        $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'";
        $giftVal = $conn->query($getGift);
        foreach ($giftVal as $gift => $val) {
            $arrData[$val['sid']][$val['name']] = $val;

        }



        $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
        $filVal = $conn->query($getFiliala);


        $arrShowF = array();
        foreach ($arrData as $IDgift => $val) {
            foreach ($val as $name => $val2) {
                if ($name == 'categoria_de_produs' && $val2['value'] == 3) {
                    // $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name3' => $arrData[$IDgift]['premiu']['value'] ,'filiala3' => $arrData[$IDgift]['filiala']['value'],'stock3' => $arrData[$IDgift]['stock']['value'],'suplimentar3' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );

                    $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name3'] = $arrData[$IDgift]['premiu']['value'];
                    $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala3'] = $arrData[$IDgift]['filiala']['value'];
                    $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock3'] +=  $arrData[$IDgift]['stock']['value'];
                    $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar3'] +=  $arrData[$IDgift]['suplimentar']['value'];
                    $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
                }
                if ($name == 'categoria_de_produs' && $val2['value'] == 2) {
                    // $val['title'] = $val[''];
                    // $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name2' => $arrData[$IDgift]['premiu']['value'] ,'filiala2' => $arrData[$IDgift]['filiala']['value'],'stock2' => $arrData[$IDgift]['stock']['value'],'suplimentar2' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
                    $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name2'] = $arrData[$IDgift]['premiu']['value'];
                    $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala2'] = $arrData[$IDgift]['filiala']['value'];
                    $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock2'] +=  $arrData[$IDgift]['stock']['value'];
                    $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar2'] +=  $arrData[$IDgift]['suplimentar']['value'];
                    $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
                }
                if ($name == 'categoria_de_produs' && $val2['value'] == 1) {
                    // $val['title'] = $val[''];
                    // $arrShowF1[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value'] ][] = array( 'name1' => $arrData[$IDgift]['premiu']['value'] ,'filiala1' => $arrData[$IDgift]['filiala']['value'],'stock1' => $arrData[$IDgift]['stock']['value'],'suplimentar1' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
                    $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name1'] = $arrData[$IDgift]['premiu']['value'];
                    $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala1'] = $arrData[$IDgift]['filiala']['value'];
                    $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock1'] +=  $arrData[$IDgift]['stock']['value'];
                    $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar1'] +=  $arrData[$IDgift]['suplimentar']['value'];
                    $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
                }
            }
        }
        $arr = [];



        if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
            $solicitate = 'Запрошено';
            $stock_init = 'Начальный сток';
            $supliment = 'Дополнение';
            $stoc_dispon = 'Наличие в стоке';
            $eliberate = 'Выпуск';
            $stoc_final = 'Финальный сток';
            $grad = 'Класс';
            $premiu = 'Приз';
            $premFil = 'Филиал';
        }
        if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
            $solicitate = 'Solicitate';
            $stock_init = 'Stoc initial';
            $supliment = 'Suplimentar';
            $stoc_dispon = 'Stoc disponibil';
            $eliberate = 'Eliberate';
            $stoc_final = 'Stoc final';
            $grad = 'Gradul';
            $premiu = 'Premiu';
            $premFil = 'Filiala';
        }

      $dataSQL = "SELECT * FROM promo_code WHERE active != 0 ORDER BY data DESC";
      $data = $conn->query($dataSQL);

      foreach ($data as $dataVal) {

      }

      $date = new DateTime($dataVal['data']);
      $date->add(new DateInterval('P7D'));
      $week1 = $date->format('Y-m-d H:i:s');

      $date = new DateTime($week1);
      $date->add(new DateInterval('P7D'));
      $week2 = $date->format('Y-m-d H:i:s');

      $date = new DateTime($week2);
      $date->add(new DateInterval('P7D'));
      $week3 = $date->format('Y-m-d H:i:s');

      $date = new DateTime($week3);
      $date->add(new DateInterval('P7D'));
      $week4 = $date->format('Y-m-d H:i:s');

      $date = new DateTime($week4);
      $date->add(new DateInterval('P7D'));
      $week5 = $date->format('Y-m-d H:i:s');

      $date = new DateTime($week5);
      $date->add(new DateInterval('P7D'));
      $week6 = $date->format('Y-m-d H:i:s');

      $date = new DateTime($week6);
      $date->add(new DateInterval('P7D'));
      $week7 = $date->format('Y-m-d H:i:s');


      $date = new DateTime($week7);
      $date->add(new DateInterval('P7D'));
      $week8 = $date->format('Y-m-d H:i:s');

//      week8

      print <<<TABLE
            <table id="table8">
            <thead>
            <tr><th>$grad 3</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
            </thead>
            <tbody>
            TABLE;
      $count = 1;
      $solicit = 0;
      foreach ($filVal as $arrFil) {
        foreach ($arrShowF as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week7."' AND '".$week8."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $stockInit = 0;

          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil['value'] . "' AND premiu = '" . $arrShow['name3'] . "' AND data BETWEEN '".$week7."' AND '".$week8."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name3'] && $arrValue['filiala'] == $arrFil['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week7."' AND '".$week8."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name3']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name3'], $arrFil['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 2</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil2) {
        foreach ($arrShowF2 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week7."' AND '".$week8."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil2['value'] . "' AND premiu = '" . $arrShow['name2'] . "' AND data BETWEEN '".$week7."' AND '".$week8."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name2'] && $arrValue['filiala'] == $arrFil2['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week7."' AND '".$week8."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name2']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name2'], $arrFil2['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }


      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 1</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil1) {
        foreach ($arrShowF1 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week7."' AND '".$week8."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil1['value'] . "' AND premiu = '" . $arrShow['name1'] . "' AND data BETWEEN '".$week7."' AND '".$week8."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name1'] && $arrValue['filiala'] == $arrFil1['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week7."' AND '".$week8."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name1']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name1'], $arrFil1['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print "<div class='week'>Saptamana 8</div>";


      $arrData  = array();
      $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'";
      $giftVal = $conn->query($getGift);
      foreach ($giftVal as $gift => $val) {
        $arrData[$val['sid']][$val['name']] = $val;

      }



      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);


      $arrShowF = array();
      foreach ($arrData as $IDgift => $val) {
        foreach ($val as $name => $val2) {
          if ($name == 'categoria_de_produs' && $val2['value'] == 3) {
            // $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name3' => $arrData[$IDgift]['premiu']['value'] ,'filiala3' => $arrData[$IDgift]['filiala']['value'],'stock3' => $arrData[$IDgift]['stock']['value'],'suplimentar3' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );

            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name3'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala3'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock3'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar3'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 2) {
            // $val['title'] = $val[''];
            // $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name2' => $arrData[$IDgift]['premiu']['value'] ,'filiala2' => $arrData[$IDgift]['filiala']['value'],'stock2' => $arrData[$IDgift]['stock']['value'],'suplimentar2' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name2'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala2'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock2'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar2'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 1) {
            // $val['title'] = $val[''];
            // $arrShowF1[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value'] ][] = array( 'name1' => $arrData[$IDgift]['premiu']['value'] ,'filiala1' => $arrData[$IDgift]['filiala']['value'],'stock1' => $arrData[$IDgift]['stock']['value'],'suplimentar1' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name1'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala1'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock1'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar1'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
        }
      }


//      week7

      print <<<TABLE
            <table id="table8">
            <thead>
            <tr><th>$grad 3</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
            </thead>
            <tbody>
            TABLE;
      $count = 1;
      $solicit = 0;
      foreach ($filVal as $arrFil) {
        foreach ($arrShowF as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week6."' AND '".$week7."'";
          $stockInfo = $conn->query($getStock);
          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $stockInit = 0;

          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil['value'] . "' AND premiu = '" . $arrShow['name3'] . "' AND data BETWEEN '".$week6."' AND '".$week7."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name3'] && $arrValue['filiala'] == $arrFil['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week6."' AND '".$week7."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name3']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name3'], $arrFil['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 2</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil2) {
        foreach ($arrShowF2 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week6."' AND '".$week7."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil2['value'] . "' AND premiu = '" . $arrShow['name2'] . "' AND data BETWEEN '".$week6."' AND '".$week7."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name2'] && $arrValue['filiala'] == $arrFil2['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week6."' AND '".$week7."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name2']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name2'], $arrFil2['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }


      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 1</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil1) {
        foreach ($arrShowF1 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week6."' AND '".$week7."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil1['value'] . "' AND premiu = '" . $arrShow['name1'] . "' AND data BETWEEN '".$week6."' AND '".$week7."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name1'] && $arrValue['filiala'] == $arrFil1['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week6."' AND '".$week7."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name1']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name1'], $arrFil1['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print "<div class='week'>Saptamana 7</div>";


      $arrData  = array();
      $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'";
      $giftVal = $conn->query($getGift);
      foreach ($giftVal as $gift => $val) {
        $arrData[$val['sid']][$val['name']] = $val;

      }



      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);


      $arrShowF = array();
      foreach ($arrData as $IDgift => $val) {
        foreach ($val as $name => $val2) {
          if ($name == 'categoria_de_produs' && $val2['value'] == 3) {
            // $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name3' => $arrData[$IDgift]['premiu']['value'] ,'filiala3' => $arrData[$IDgift]['filiala']['value'],'stock3' => $arrData[$IDgift]['stock']['value'],'suplimentar3' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );

            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name3'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala3'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock3'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar3'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 2) {
            // $val['title'] = $val[''];
            // $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name2' => $arrData[$IDgift]['premiu']['value'] ,'filiala2' => $arrData[$IDgift]['filiala']['value'],'stock2' => $arrData[$IDgift]['stock']['value'],'suplimentar2' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name2'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala2'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock2'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar2'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 1) {
            // $val['title'] = $val[''];
            // $arrShowF1[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value'] ][] = array( 'name1' => $arrData[$IDgift]['premiu']['value'] ,'filiala1' => $arrData[$IDgift]['filiala']['value'],'stock1' => $arrData[$IDgift]['stock']['value'],'suplimentar1' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name1'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala1'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock1'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar1'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
        }
      }

//      week6

      print <<<TABLE
            <table id="table8">
            <thead>
            <tr><th>$grad 3</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
            </thead>
            <tbody>
            TABLE;
      $count = 1;
      $solicit = 0;
      foreach ($filVal as $arrFil) {
        foreach ($arrShowF as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week5."' AND '".$week6."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $stockInit = 0;

          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil['value'] . "' AND premiu = '" . $arrShow['name3'] . "' AND data BETWEEN '".$week5."' AND '".$week6."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name3'] && $arrValue['filiala'] == $arrFil['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week5."' AND '".$week6."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name3']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name3'], $arrFil['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 2</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil2) {
        foreach ($arrShowF2 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week5."' AND '".$week6."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil2['value'] . "' AND premiu = '" . $arrShow['name2'] . "' AND data BETWEEN '".$week5."' AND '".$week6."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name2'] && $arrValue['filiala'] == $arrFil2['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week5."' AND '".$week6."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name2']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name2'], $arrFil2['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }


      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 1</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil1) {
        foreach ($arrShowF1 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week5."' AND '".$week6."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil1['value'] . "' AND premiu = '" . $arrShow['name1'] . "' AND data BETWEEN '".$week5."' AND '".$week6."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name1'] && $arrValue['filiala'] == $arrFil1['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week5."' AND '".$week6."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name1']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name1'], $arrFil1['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print "<div class='week'>Saptamana 6</div>";


      $arrData  = array();
      $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'";
      $giftVal = $conn->query($getGift);
      foreach ($giftVal as $gift => $val) {
        $arrData[$val['sid']][$val['name']] = $val;

      }



      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);


      $arrShowF = array();
      foreach ($arrData as $IDgift => $val) {
        foreach ($val as $name => $val2) {
          if ($name == 'categoria_de_produs' && $val2['value'] == 3) {
            // $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name3' => $arrData[$IDgift]['premiu']['value'] ,'filiala3' => $arrData[$IDgift]['filiala']['value'],'stock3' => $arrData[$IDgift]['stock']['value'],'suplimentar3' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );

            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name3'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala3'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock3'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar3'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 2) {
            // $val['title'] = $val[''];
            // $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name2' => $arrData[$IDgift]['premiu']['value'] ,'filiala2' => $arrData[$IDgift]['filiala']['value'],'stock2' => $arrData[$IDgift]['stock']['value'],'suplimentar2' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name2'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala2'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock2'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar2'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 1) {
            // $val['title'] = $val[''];
            // $arrShowF1[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value'] ][] = array( 'name1' => $arrData[$IDgift]['premiu']['value'] ,'filiala1' => $arrData[$IDgift]['filiala']['value'],'stock1' => $arrData[$IDgift]['stock']['value'],'suplimentar1' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name1'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala1'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock1'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar1'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
        }
      }

//      week5
      print <<<TABLE
            <table id="table8">
            <thead>
            <tr><th>$grad 3</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
            </thead>
            <tbody>
            TABLE;
      $count = 1;
      $solicit = 0;
      foreach ($filVal as $arrFil) {
        foreach ($arrShowF as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week4."' AND '".$week5."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $stockInit = 0;

          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil['value'] . "' AND premiu = '" . $arrShow['name3'] . "' AND data BETWEEN '".$week4."' AND '".$week5."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name3'] && $arrValue['filiala'] == $arrFil['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week4."' AND '".$week5."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name3']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name3'], $arrFil['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 2</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil2) {
        foreach ($arrShowF2 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week4."' AND '".$week5."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil2['value'] . "' AND premiu = '" . $arrShow['name2'] . "' AND data BETWEEN '".$week4."' AND '".$week5."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name2'] && $arrValue['filiala'] == $arrFil2['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week4."' AND '".$week5."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name2']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name2'], $arrFil2['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }


      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 1</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil1) {
        foreach ($arrShowF1 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week4."' AND '".$week5."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil1['value'] . "' AND premiu = '" . $arrShow['name1'] . "' AND data BETWEEN '".$week4."' AND '".$week5."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name1'] && $arrValue['filiala'] == $arrFil1['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week4."' AND '".$week5."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name1']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name1'], $arrFil1['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print "<div class='week'>Saptamana 5</div>";

      $arrData  = array();
      $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'";
      $giftVal = $conn->query($getGift);
      foreach ($giftVal as $gift => $val) {
        $arrData[$val['sid']][$val['name']] = $val;

      }



      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);


      $arrShowF = array();
      foreach ($arrData as $IDgift => $val) {
        foreach ($val as $name => $val2) {
          if ($name == 'categoria_de_produs' && $val2['value'] == 3) {
            // $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name3' => $arrData[$IDgift]['premiu']['value'] ,'filiala3' => $arrData[$IDgift]['filiala']['value'],'stock3' => $arrData[$IDgift]['stock']['value'],'suplimentar3' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );

            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name3'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala3'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock3'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar3'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 2) {
            // $val['title'] = $val[''];
            // $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name2' => $arrData[$IDgift]['premiu']['value'] ,'filiala2' => $arrData[$IDgift]['filiala']['value'],'stock2' => $arrData[$IDgift]['stock']['value'],'suplimentar2' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name2'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala2'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock2'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar2'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 1) {
            // $val['title'] = $val[''];
            // $arrShowF1[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value'] ][] = array( 'name1' => $arrData[$IDgift]['premiu']['value'] ,'filiala1' => $arrData[$IDgift]['filiala']['value'],'stock1' => $arrData[$IDgift]['stock']['value'],'suplimentar1' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name1'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala1'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock1'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar1'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
        }
      }

//      week4

      print <<<TABLE
            <table id="table8">
            <thead>
            <tr><th>$grad 3</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
            </thead>
            <tbody>
            TABLE;
      $count = 1;
      $solicit = 0;
      foreach ($filVal as $arrFil) {
        foreach ($arrShowF as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week3."' AND '".$week4."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $stockInit = 0;

          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil['value'] . "' AND premiu = '" . $arrShow['name3'] . "' AND data BETWEEN '".$week3."' AND '".$week4."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name3'] && $arrValue['filiala'] == $arrFil['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week3."' AND '".$week4."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name3']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name3'], $arrFil['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 2</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil2) {
        foreach ($arrShowF2 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week3."' AND '".$week4."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil2['value'] . "' AND premiu = '" . $arrShow['name2'] . "' AND data BETWEEN '".$week3."' AND '".$week4."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name2'] && $arrValue['filiala'] == $arrFil2['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week3."' AND '".$week4."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name2']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name2'], $arrFil2['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }


      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 1</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil1) {
        foreach ($arrShowF1 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week3."' AND '".$week4."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil1['value'] . "' AND premiu = '" . $arrShow['name1'] . "' AND data BETWEEN '".$week3."' AND '".$week4."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name1'] && $arrValue['filiala'] == $arrFil1['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week3."' AND '".$week4."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name1']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name1'], $arrFil1['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print "<div class='week'>Saptamana 4</div>";

      $arrData  = array();
      $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'";
      $giftVal = $conn->query($getGift);
      foreach ($giftVal as $gift => $val) {
        $arrData[$val['sid']][$val['name']] = $val;

      }



      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);


      $arrShowF = array();
      foreach ($arrData as $IDgift => $val) {
        foreach ($val as $name => $val2) {
          if ($name == 'categoria_de_produs' && $val2['value'] == 3) {
            // $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name3' => $arrData[$IDgift]['premiu']['value'] ,'filiala3' => $arrData[$IDgift]['filiala']['value'],'stock3' => $arrData[$IDgift]['stock']['value'],'suplimentar3' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );

            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name3'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala3'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock3'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar3'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 2) {
            // $val['title'] = $val[''];
            // $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name2' => $arrData[$IDgift]['premiu']['value'] ,'filiala2' => $arrData[$IDgift]['filiala']['value'],'stock2' => $arrData[$IDgift]['stock']['value'],'suplimentar2' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name2'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala2'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock2'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar2'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 1) {
            // $val['title'] = $val[''];
            // $arrShowF1[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value'] ][] = array( 'name1' => $arrData[$IDgift]['premiu']['value'] ,'filiala1' => $arrData[$IDgift]['filiala']['value'],'stock1' => $arrData[$IDgift]['stock']['value'],'suplimentar1' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name1'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala1'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock1'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar1'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
        }
      }

//      week3


      print <<<TABLE
            <table id="table8">
            <thead>
            <tr><th>$grad 3</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
            </thead>
            <tbody>
            TABLE;
      $count = 1;
      $solicit = 0;
      foreach ($filVal as $arrFil) {
        foreach ($arrShowF as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week2."' AND '".$week3."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $stockInit = 0;

          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil['value'] . "' AND premiu = '" . $arrShow['name3'] . "' AND data BETWEEN '".$week2."' AND '".$week3."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name3'] && $arrValue['filiala'] == $arrFil['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week2."' AND '".$week3."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name3']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name3'], $arrFil['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 2</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil2) {
        foreach ($arrShowF2 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week2."' AND '".$week3."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil2['value'] . "' AND premiu = '" . $arrShow['name2'] . "' AND data BETWEEN '".$week2."' AND '".$week3."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name2'] && $arrValue['filiala'] == $arrFil2['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week2."' AND '".$week3."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name2']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name2'], $arrFil2['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }


      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 1</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil1) {
        foreach ($arrShowF1 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week2."' AND '".$week3."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil1['value'] . "' AND premiu = '" . $arrShow['name1'] . "' AND data BETWEEN '".$week2."' AND '".$week3."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name1'] && $arrValue['filiala'] == $arrFil1['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week2."' AND '".$week3."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name1']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name1'], $arrFil1['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print "<div class='week'>Saptamana 3</div>";


      $arrData  = array();
      $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'";
      $giftVal = $conn->query($getGift);
      foreach ($giftVal as $gift => $val) {
        $arrData[$val['sid']][$val['name']] = $val;

      }



      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);


      $arrShowF = array();
      foreach ($arrData as $IDgift => $val) {
        foreach ($val as $name => $val2) {
          if ($name == 'categoria_de_produs' && $val2['value'] == 3) {
            // $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name3' => $arrData[$IDgift]['premiu']['value'] ,'filiala3' => $arrData[$IDgift]['filiala']['value'],'stock3' => $arrData[$IDgift]['stock']['value'],'suplimentar3' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );

            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name3'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala3'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock3'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar3'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 2) {
            // $val['title'] = $val[''];
            // $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name2' => $arrData[$IDgift]['premiu']['value'] ,'filiala2' => $arrData[$IDgift]['filiala']['value'],'stock2' => $arrData[$IDgift]['stock']['value'],'suplimentar2' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name2'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala2'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock2'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar2'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 1) {
            // $val['title'] = $val[''];
            // $arrShowF1[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value'] ][] = array( 'name1' => $arrData[$IDgift]['premiu']['value'] ,'filiala1' => $arrData[$IDgift]['filiala']['value'],'stock1' => $arrData[$IDgift]['stock']['value'],'suplimentar1' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name1'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala1'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock1'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar1'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
        }
      }


//    week2

      print <<<TABLE
            <table id="table8">
            <thead>
            <tr><th>$grad 3</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
            </thead>
            <tbody>
            TABLE;
      $count = 1;
      $solicit = 0;
      foreach ($filVal as $arrFil) {
        foreach ($arrShowF as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week1."' AND '".$week2."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $stockInit = 0;

          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil['value'] . "' AND premiu = '" . $arrShow['name3'] . "' AND data BETWEEN '".$week1."' AND '".$week2."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name3'] && $arrValue['filiala'] == $arrFil['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week1."' AND '".$week2."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name3']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name3'], $arrFil['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 2</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil2) {
        foreach ($arrShowF2 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week1."' AND '".$week2."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil2['value'] . "' AND premiu = '" . $arrShow['name2'] . "' AND data BETWEEN '".$week1."' AND '".$week2."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name2'] && $arrValue['filiala'] == $arrFil2['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week1."' AND '".$week2."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name2']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name2'], $arrFil2['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }


      print "</tbody>\n</table>\n";

      print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 1</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
      $count = 1;
      $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil1) {
        foreach ($arrShowF1 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$week1."' AND '".$week2."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil1['value'] . "' AND premiu = '" . $arrShow['name1'] . "' AND data BETWEEN '".$week1."' AND '".$week2."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name1'] && $arrValue['filiala'] == $arrFil1['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$week1."' AND '".$week2."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name1']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name1'], $arrFil1['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

      print "</tbody>\n</table>\n";

      print "<div class='week'>Saptamana 2</div>";

      $arrData  = array();
      $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'";
      $giftVal = $conn->query($getGift);
      foreach ($giftVal as $gift => $val) {
        $arrData[$val['sid']][$val['name']] = $val;

      }



      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);


      $arrShowF = array();
      foreach ($arrData as $IDgift => $val) {
        foreach ($val as $name => $val2) {
          if ($name == 'categoria_de_produs' && $val2['value'] == 3) {
            // $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name3' => $arrData[$IDgift]['premiu']['value'] ,'filiala3' => $arrData[$IDgift]['filiala']['value'],'stock3' => $arrData[$IDgift]['stock']['value'],'suplimentar3' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );

            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name3'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala3'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock3'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar3'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 2) {
            // $val['title'] = $val[''];
            // $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name2' => $arrData[$IDgift]['premiu']['value'] ,'filiala2' => $arrData[$IDgift]['filiala']['value'],'stock2' => $arrData[$IDgift]['stock']['value'],'suplimentar2' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name2'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala2'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock2'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar2'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
          if ($name == 'categoria_de_produs' && $val2['value'] == 1) {
            // $val['title'] = $val[''];
            // $arrShowF1[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value'] ][] = array( 'name1' => $arrData[$IDgift]['premiu']['value'] ,'filiala1' => $arrData[$IDgift]['filiala']['value'],'stock1' => $arrData[$IDgift]['stock']['value'],'suplimentar1' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['name1'] = $arrData[$IDgift]['premiu']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['filiala1'] = $arrData[$IDgift]['filiala']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['stock1'] +=  $arrData[$IDgift]['stock']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['suplimentar1'] +=  $arrData[$IDgift]['suplimentar']['value'];
            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['nume_filiala']['value']]['id'] +=  $IDgift;
          }
        }
      }


//      week1
      print <<<TABLE
            <table id="table8">
            <thead>
            <tr><th>$grad 3</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
            </thead>
            <tbody>
            TABLE;
        $count = 1;
        $solicit = 0;
        foreach ($filVal as $arrFil) {
          foreach ($arrShowF as $filiala => $arrShow) {
            $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$dataVal['data']."' AND '".$week1."'";
            $stockInfo = $conn->query($getStock);

            $combinedArray = array();
            foreach ($stockInfo as $info) {
              $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

              if (!isset($combinedArray[$premiuFiliala])) {
                $combinedArray[$premiuFiliala] = array(
                  'initial' => 0,
                  'suplimentar' => 0,
                  'data' => ''
                );
              }

              $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
              $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
              $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
              $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
              $combinedArray[$premiuFiliala]['data'] = $info['data'];
            }
            $stockInit = 0;

            $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil['value'] . "' AND premiu = '" . $arrShow['name3'] . "' AND data BETWEEN '".$dataVal['data']."' AND '".$week1."'";
            $sol = $conn->query($solicitSQL);
            $solicit = 0;
            foreach ($sol as $solVal) {
              $solicit++;
            }
            $supl = 0;
            $initStock = 0;
            foreach ($combinedArray as $arrKey => $arrValue){
              if($arrValue['premiu'] == $arrShow['name3'] && $arrValue['filiala'] == $arrFil['value']){
                $supl = $arrValue['suplimentar'];
                $initStock = $arrValue['initial'];
              }
            }
            $stockDisp = $initStock + $supl;

            $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$dataVal['data']."' AND '".$week1."'";
            $elib = $conn->query($elibSQL);
            $countElib = 0;
            foreach ($elib as $elibVal) {
              if($elibVal['premiu'] == $arrShow['name3']) {
                $countElib++;
              }
            }
            $stockFinal = $stockDisp - $countElib;
            printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name3'], $arrFil['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

            $count++;
          }
        }

        print "</tbody>\n</table>\n";

        print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 2</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
        $count = 1;
        $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil2) {
        foreach ($arrShowF2 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$dataVal['data']."' AND '".$week1."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil2['value'] . "' AND premiu = '" . $arrShow['name2'] . "' AND data BETWEEN '".$dataVal['data']."' AND '".$week1."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name2'] && $arrValue['filiala'] == $arrFil2['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$dataVal['data']."' AND '".$week1."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name2']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name2'], $arrFil2['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }


        print "</tbody>\n</table>\n";

        print <<<TABLE
                       <table id="table8">
                       <thead>
                       <tr><th>$grad 1</th><th>$premiu</th><th>$premFil</th><th>$solicitate</th><th>$stock_init</th><th>$supliment</th><th>$stoc_dispon</th><th>$eliberate</th><th>$stoc_final</th></tr>
                       </thead>
                       <tbody>
                       TABLE;
        $count = 1;
        $solicit = 0;
      $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
      $filVal = $conn->query($getFiliala);
      foreach ($filVal as $arrFil1) {
        foreach ($arrShowF1 as $filiala => $arrShow) {
          $getStock = "SELECT * FROM stock WHERE data BETWEEN '".$dataVal['data']."' AND '".$week1."'";
          $stockInfo = $conn->query($getStock);

          $combinedArray = array();
          foreach ($stockInfo as $info) {
            $premiuFiliala = $info['premiu'] . "_" . $info['filiala'];

            if (!isset($combinedArray[$premiuFiliala])) {
              $combinedArray[$premiuFiliala] = array(
                'initial' => 0,
                'suplimentar' => 0,
                'data' => ''
              );
            }

            $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
            $combinedArray[$premiuFiliala]['filiala'] = $info['filiala'];
            $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
            $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
            $combinedArray[$premiuFiliala]['data'] = $info['data'];
          }
          $solicitSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrFil1['value'] . "' AND premiu = '" . $arrShow['name1'] . "' AND data BETWEEN '".$dataVal['data']."' AND '".$week1."'";
          $sol = $conn->query($solicitSQL);
          $solicit = 0;
          foreach ($sol as $solVal) {
            $solicit++;
          }
          $supl = 0;
          $initStock = 0;
          foreach ($combinedArray as $arrKey => $arrValue){
            if($arrValue['premiu'] == $arrShow['name1'] && $arrValue['filiala'] == $arrFil1['value']){
              $supl = $arrValue['suplimentar'];
              $initStock = $arrValue['initial'];
            }
          }
          $stockDisp = $initStock + $supl;

          $elibSQL = "SELECT * FROM promo_code WHERE active != 0 AND status = 3 AND data BETWEEN '".$dataVal['data']."' AND '".$week1."'";
          $elib = $conn->query($elibSQL);
          $countElib = 0;
          foreach ($elib as $elibVal) {
            if($elibVal['premiu'] == $arrShow['name1']) {
              $countElib++;
            }
          }
          $stockFinal = $stockDisp - $countElib;
          printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $arrShow['name1'], $arrFil1['value'], $solicit, $initStock, $supl, $stockDisp, $countElib, $stockFinal);

          $count++;
        }
      }

        print "</tbody>\n</table>\n";

      print "<div class='week'>Saptamana 1</div>";

    }
}

function nescafe_preprocess_region__details($details)
{

    $roles = \Drupal::currentUser()->getRoles();
    $curr_id_for_user = \Drupal::currentUser()->id();


    $config = new Config();
    $credentials = $config->credentials('database');
    $dsn = sprintf('mysql:host=%s;port=%d;dbname=%s', $credentials['host'], $credentials['port'], $credentials['path']);
    $conn = new \PDO($dsn, $credentials['username'], $credentials['password'], [
        \PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION,
        \PDO::MYSQL_ATTR_USE_BUFFERED_QUERY => TRUE,
        \PDO::MYSQL_ATTR_FOUND_ROWS => TRUE,
    ]);


    if (in_array('authenticated', $roles) && !in_array('manager_filiala', $roles) && in_array('administrator', $roles)) {
        if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
            $name = 'Имя';
            $phone = 'Телефон';
            $action = "Детали";
            $mail = 'Фамилия';
            $stats = 'Сток';
            $prem = 'Приз';
            $livrare = 'Филиал';
            $promoCode = "Промокод";
            $state = 'Статус';
            $stateON = 'Выдан в -> ';
            $stateOFF = "В ожидании";
        }
        if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
            $name = 'Nume';
            $phone = "Telefon";
            $action = 'Detalii';
            $mail = 'Prenume';
            $stats = 'Stoc';
            $prem = 'Premiu';
            $livrare = 'Filiala';
            $promoCode = "Promocod";
            $state = 'Statut';
            $stateON = 'Ridicat în -> ';
            $stateOFF = "In Asteptare";
        }

        $sqlQuery = "SELECT * FROM users_field_data LEFT JOIN `user__field_phone` ON `users_field_data`.`uid` = `user__field_phone`.`revision_id` LEFT JOIN `promo_code` ON `users_field_data`.uid = `promo_code`.active  LEFT JOIN `user__field_name` ON `users_field_data`.`uid` = `user__field_name`.`entity_id` LEFT JOIN `user__field_lastname` ON `users_field_data`.`uid` = `user__field_lastname`.`entity_id` WHERE uid != 0 AND `promo_code`.`active` = '" . $_GET['id'] . "' ORDER BY uid ASC";


        $sql = $sqlQuery;
        //dump($sql);
        $result = $conn->query($sql);
        $result->setFetchMode(\PDO::FETCH_OBJ);

        print <<<TABLE
                  <table id="table8">
                  <thead>
                  <tr><th>ID</th><th>$name</th><th>$mail</th><th>$phone</th><th>$prem</th><th>$livrare</th><th>$promoCode</th><th>$state</th></tr>
                  </thead>
                  <tbody>
                  TABLE;
        $count = 1;
        foreach ($result as $record) {
            if ($record->status == 2) {
                $statusPrint = $stateOFF;
            } else if ($record->status == 3) {
                $statusPrint = $stateON;
            } else {
                $statusPrint = '';
            }
            printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $record->field_name_value,$record->field_lastname_value, $record->name, $record->premiu, $record->livrare, $record->promocode, $statusPrint.$record->filiala_elib);

            $count++;
        }

        print "</tbody>\n</table>\n";
    }
}

/* Таблица с участниками в томболе */
function nescafe_preprocess_region__tombola()
{

    $roles = \Drupal::currentUser()->getRoles();
    $curr_id_for_user = \Drupal::currentUser()->id();


    $config = new Config();
    $credentials = $config->credentials('database');
    $dsn = sprintf('mysql:host=%s;port=%d;dbname=%s', $credentials['host'], $credentials['port'], $credentials['path']);
    $conn = new \PDO($dsn, $credentials['username'], $credentials['password'], [
        \PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION,
        \PDO::MYSQL_ATTR_USE_BUFFERED_QUERY => TRUE,
        \PDO::MYSQL_ATTR_FOUND_ROWS => TRUE,
    ]);

    if (in_array('authenticated', $roles) && !in_array('manager_filiala', $roles) && in_array('administrator', $roles)) {
        if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
            $name = 'Имя';
            $phone = 'Телефон';
            $action = "Детали";
            $mail = 'Почта';
            $stats = 'Сток';
            $promoCode = "Промокод";
        }
        if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
            $name = 'Nume';
            $phone = "Telefon";
            $action = 'Detalii';
            $mail = 'Posta';
            $stats = 'Stoc';
            $promoCode = "Promocod";
        }

        $sqlQuery = "SELECT * FROM users_field_data LEFT JOIN `user__field_name` ON `users_field_data`.`uid` = `user__field_name`.`revision_id` LEFT JOIN `promo_code` ON `users_field_data`.uid = `promo_code`.active WHERE uid != 0 AND `promo_code`.`active` != 0 AND final != 0 ORDER BY uid ASC";
        $sql = $sqlQuery;
        //dump($sql);
        $result = $conn->query($sql);
        $result->setFetchMode(\PDO::FETCH_OBJ);

        print <<<TABLE
                          <table id="table8">
                          <thead>
                          <tr><th>ID</th><th>$name</th><th>$mail</th><th>$phone</th><th>$promoCode</th></tr>
                          </thead>
                          <tbody>
                          TABLE;
        $count = 1;
        foreach ($result as $record) {
            if ($record->status == 2) {
                $statusPrint = $stateOFF;
            } else if ($record->status == 3) {
                $statusPrint = $stateON;
            } else {
                $statusPrint = '';
            }
            printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $count, $record->field_name_value, $record->mail, $record->name, $record->promocode);

            $count++;
        }

        print "</tbody>\n</table>\n";
    }
}

function nescafe_preprocess_region__reset()
{

    $config = new Config();
    $credentials = $config->credentials('database');
    $dsn = sprintf('mysql:host=%s;port=%d;dbname=%s', $credentials['host'], $credentials['port'], $credentials['path']);
    $conn = new \PDO($dsn, $credentials['username'], $credentials['password'], [
        \PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION,
        \PDO::MYSQL_ATTR_USE_BUFFERED_QUERY => TRUE,
        \PDO::MYSQL_ATTR_FOUND_ROWS => TRUE,
    ]);

    if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
        $intro = 'Введите номер телефона для восстановления пароля';
        $send = "Отправить";
    }
    if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
        $intro = 'Introduceti numarul de telefon ca sa restabiliti parola';
        $send = "Trimite";
    }

    print "<div class='promo_add'>
    <form method='post'>
    <div class='promo_group promo_reset_pass'>
    <label>$intro</label>
    <input type='text' class='promo_add_inp reset_pass' name='reset_password'>
    </div>
    <input type='submit' value='$send' class='promo_send' name='submit_password'>
    </form>
    </div>";



    if(isset($_POST["submit_password"])){
         $getUser = "SELECT * FROM users_field_data WHERE name = '".$_POST['reset_password']."'  LIMIT 1";
         $getUserVal = $conn->query($getUser);
         $getUserVal->setFetchMode(\PDO::FETCH_OBJ);
         $curr = 0;
         foreach($getUserVal as $val){
            $curr++;
         }
         if($curr == 1){

         $alphabet = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890';
             $pass = array(); //remember to declare $pass as an array
             $alphaLength = strlen($alphabet) - 1; //put the length -1 in cache
             for ($i = 0; $i < 8; $i++) {
                 $n = rand(0, $alphaLength);
                 $pass[] = $alphabet[$n];
             }
             $newPass = implode($pass);
             $phone = $_POST["reset_password"];


            $params = array(

              'type' => 'SendSms' ,

              'phone' => $phone ,

              'message' => 'Parola noua: '.$newPass.' '

            );

            $resultSend = apiBulkSmsSystem( $params );
if($resultSend['status'] == true){
$user_storage = \Drupal::entityTypeManager()->getStorage('user');

             // Load user by their user ID
             $user = $user_storage->load($val->uid);

             // Set the new password
             $user->setPassword($newPass);

             // Save the user
             $user->save();
             }else{
              print "<form method='POST' class='use-ajax webform-dialog webform-dialog-narrow popup_gift' data-dialog-type='modal'>
                   <div>Error!</div>
                   <div class='btn_main action closePopup'>Inchide</div>
               </form>
               ";
              }
         }
    }
}

/* Tabel principal */
function nescafe_preprocess_region__tabel_principal(){


    $roles = \Drupal::currentUser()->getRoles();
    $curr_id_for_user = \Drupal::currentUser()->id();


    $config = new Config();
    $credentials = $config->credentials('database');
    $dsn = sprintf('mysql:host=%s;port=%d;dbname=%s', $credentials['host'], $credentials['port'], $credentials['path']);
    $conn = new \PDO($dsn, $credentials['username'], $credentials['password'], [
        \PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION,
        \PDO::MYSQL_ATTR_USE_BUFFERED_QUERY => TRUE,
        \PDO::MYSQL_ATTR_FOUND_ROWS => TRUE,
    ]);

    if (in_array('administrator', $roles)) {
        if (in_array('authenticated', $roles) && !in_array('manager_filiala', $roles) && in_array('administrator', $roles)) {
                $arrData  = array();
                $getGift = "SELECT * FROM webform_submission_data WHERE webform_id = 'cadouri'  ";
                $giftVal = $conn->query($getGift);
                foreach ($giftVal as $gift => $val) {
                    $arrData[$val['sid']][$val['name']] = $val;
                    //dump($val);
                    //dump($val['value']);
                }

                $elibQuery = "SELECT * FROM promo_code WHERE active != 0 AND status = 3";
                $elibSQL = $conn->query($elibQuery);
                $premii = array();
                foreach ($elibSQL as $elibVal) {
                    $premii [] = $elibVal['premiu'];
                }
          $countedArray = array_count_values($premii);

          $dataSQL = "SELECT * FROM promo_code WHERE active != 0 ORDER BY data DESC";
          $data = $conn->query($dataSQL);

          foreach ($data as $dataVal) {

          }


                $arrShowF = array();
                foreach ($arrData as $IDgift => $val) {
                    foreach ($val as $name => $val2) {
                        if ($name == 'categoria_de_produs' && $val2['value'] == 3) {
                            // $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name3' => $arrData[$IDgift]['premiu']['value'] ,'filiala3' => $arrData[$IDgift]['filiala']['value'],'stock3' => $arrData[$IDgift]['stock']['value'],'suplimentar3' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );

                            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['name3'] = $arrData[$IDgift]['premiu']['value'];
                            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['image'] = $arrData[$IDgift]['gift_image']['value'];
                            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['stock3'] +=  $arrData[$IDgift]['stock']['value'];
                            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['suplimentar3'] +=  $arrData[$IDgift]['suplimentar']['value'];
                            $arrShowF[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['id'] +=  $IDgift;
                        }
                        if ($name == 'categoria_de_produs' && $val2['value'] == 2) {
                            // $val['title'] = $val[''];
                            // $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value']][] = array( 'name2' => $arrData[$IDgift]['premiu']['value'] ,'filiala2' => $arrData[$IDgift]['filiala']['value'],'stock2' => $arrData[$IDgift]['stock']['value'],'suplimentar2' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
                            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['name2'] = $arrData[$IDgift]['premiu']['value'];
                            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['image'] = $arrData[$IDgift]['gift_image']['value'];
                            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['stock2'] +=  $arrData[$IDgift]['stock']['value'];
                            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['suplimentar2'] +=  $arrData[$IDgift]['suplimentar']['value'];
                            $arrShowF2[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['id'] +=  $IDgift;
                        }
                        if ($name == 'categoria_de_produs' && $val2['value'] == 1) {
                            // $val['title'] = $val[''];
                            // $arrShowF1[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['filiala']['value'] ][] = array( 'name1' => $arrData[$IDgift]['premiu']['value'] ,'filiala1' => $arrData[$IDgift]['filiala']['value'],'stock1' => $arrData[$IDgift]['stock']['value'],'suplimentar1' => $arrData[$IDgift]['suplimentar']['value'], 'id' => $IDgift );
                            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['name1'] = $arrData[$IDgift]['premiu']['value'];
                            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['image'] = $arrData[$IDgift]['gift_image']['value'];
                            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['stock1'] +=  $arrData[$IDgift]['stock']['value'];
                            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['suplimentar1'] +=  $arrData[$IDgift]['suplimentar']['value'];
                            $arrShowF1[$arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['id'] +=  $IDgift;
                        }

                          $arrShowForm[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['name'] = $arrData[$IDgift]['premiu']['value'];
                          $arrShowForm[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['image'] = $arrData[$IDgift]['gift_image']['value'];
                          $arrShowForm[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['stock'] =  $arrData[$IDgift]['stock']['value'];
                          $arrShowForm[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['suplimentar'] =  $arrData[$IDgift]['suplimentar']['value'];
                          $arrShowForm[ $arrData[$IDgift]['premiu']['value'] . '_' . $arrData[$IDgift]['premiu']['value']]['id'] =  $IDgift;

                    }
                }


                if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
                    $sapt = 'Неделя';
                    $stoc_final = 'Доступный сток';
                    $grad = 'Класс';
                    $premiuPoza = 'Изображение';
                    $premFil = 'Количество';
                }
                if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
                    $sapt = 'Saptamana';
                    $stoc_final = 'Stoc Disponibil';
                    $grad = 'Gradul';
                    $premiuPoza = 'Poza';
                    $premFil = 'Cantitate';
                }

          $arrStock  = array();
          $getStock = "SELECT * FROM stock ";
          $stockVal = $conn->query($getStock);

          // Initialize an array to store the sums
          $sums = array();

// Process the data and calculate the sums
          foreach ($stockVal as $row) {
            $premiu = $row['premiu'];
            $filiala = $row['filiala'];
            $suplimentar = $row['suplimentar'];
            $initial = $row['initial'];

            // Check if the combination of premiu and filiala exists in the $sums array
            $key = $premiu . '_' . $filiala;
            if (!isset($sums[$key])) {
              $sums[$key] = array(
                'premiu' => $premiu,
                'filiala' => $filiala,
                'total_suplimentar' => 0,
                'total_initial' => 0,
              );
            }

            // Calculate the sums of suplimentar and initial for each combination
            $sums[$key]['total_suplimentar'] += $suplimentar;
            if ($initial !== null) {
              $sums[$key]['total_initial'] += $initial;
            }
          }

                print <<<TABLE
                    <table id="table8">
                    <thead>
                    <tr><th>$grad 3</th><th>$premiuPoza</th><th>$premFil</th><th>$sapt 1</th><th>$sapt 2</th><th>$sapt 3</th><th>$sapt 4</th><th>$sapt 5</th><th>$sapt 6</th><th>$sapt 7</th><th>$sapt 8</th><th>$stoc_final</th></tr>
                    </thead>
                    <tbody>
                    TABLE;
                $count = 1;
                $solicit = 0;
                foreach ($arrShowF as $filiala => $arrShow) {

                  $date = new DateTime($dataVal['data']);
                  $date->add(new DateInterval('P7D'));
                  $week1 = $date->format('Y-m-d H:i:s');
                  $count1 = 0;
                  $getWeek1 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$dataVal['data']."' AND '".$week1."'";
                  $getWeekOne = $conn->query($getWeek1);
                  foreach ($getWeekOne as $Week1){
                    if($Week1['premiu'] == $arrShow['name3']){
                      $count1++;
                    }
                  }

                  $date = new DateTime($week1);
                  $date->add(new DateInterval('P7D'));
                  $count2=0;
                  $week2 = $date->format('Y-m-d H:i:s');
                  $getWeek2 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week1."' AND '".$week2."'";
                  $getWeekTwo = $conn->query($getWeek2);
                  foreach ($getWeekTwo as $Week2){
                    if($Week2['premiu'] == $arrShow['name3']){
                      $count2++;
                    }
                  }

                  $date = new DateTime($week2);
                  $date->add(new DateInterval('P7D'));
                  $count3=0;
                  $week3 = $date->format('Y-m-d H:i:s');
                  $getWeek3 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week2."' AND '".$week3."'";
                  $getWeekThree = $conn->query($getWeek3);
                  foreach ($getWeekThree as $Week3){
                    if($Week3['premiu'] == $arrShow['name3']){
                      $count3++;
                    }
                  }

                  $date = new DateTime($week3);
                  $date->add(new DateInterval('P7D'));
                  $count4=0;
                  $week4 = $date->format('Y-m-d H:i:s');
                  $getWeek4 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week3."' AND '".$week4."'";
                  $getWeekFour = $conn->query($getWeek4);
                  foreach ($getWeekFour as $Week4){
                    if($Week4['premiu'] == $arrShow['name3']){
                      $count4++;
                    }
                  }

                  $date = new DateTime($week4);
                  $date->add(new DateInterval('P7D'));
                  $count5=0;
                  $week5 = $date->format('Y-m-d H:i:s');
                  $getWeek5 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week4."' AND '".$week5."'";
                  $getWeekFive = $conn->query($getWeek5);
                  foreach ($getWeekFive as $Week5){
                    if($Week5['premiu'] == $arrShow['name3']){
                      $count5++;
                    }
                  }

                  $date = new DateTime($week5);
                  $date->add(new DateInterval('P7D'));
                  $count6=0;
                  $week6 = $date->format('Y-m-d H:i:s');
                  $getWeek6 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week5."' AND '".$week6."'";
                  $getWeekSix = $conn->query($getWeek6);
                  foreach ($getWeekSix as $Week6){
                    if($Week6['premiu'] == $arrShow['name3']){
                      $count6++;
                    }
                  }

                  $date = new DateTime($week6);
                  $date->add(new DateInterval('P7D'));
                  $count7=0;
                  $week7 = $date->format('Y-m-d H:i:s');
                  $getWeek7 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week6."' AND '".$week7."'";
                  $getWeekSeven = $conn->query($getWeek7);
                  foreach ($getWeekSeven as $Week7){
                    if($Week7['premiu'] == $arrShow['name3']){
                      $count7++;
                    }
                  }

                  $date = new DateTime($week7);
                  $date->add(new DateInterval('P7D'));
                  $count8 = 0;
                  $week8 = $date->format('Y-m-d H:i:s');
                  $getWeek8 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week7."' AND '".$week8."'";
                  $getWeekEight = $conn->query($getWeek8);
                  foreach ($getWeekEight as $Week8){
                    if($Week8['premiu'] == $arrShow['name3']){
                      $count8++;
                    }
                  }



                  foreach ($sums as $sum) {
                    if($sum['premiu'] == $arrShow['name3']){
                      $sum3 = $sum['total_suplimentar'] + $sum['total_initial'];
                    }
                  }

//                  if($arrShow['suplimentar3'] - $sum3 >= 0){
//                    $supliment = $arrShow['suplimentar3'] - $sum3;
//                  }else{
//                    $supliment = $arrShow['suplimentar3'];
//                  }
                  $supliment = $arrShow['suplimentar3'];
                  foreach ($countedArray as $key => $value){
                    if($arrShow['name3'] == $key){
                      $supliment = $arrShow['suplimentar3'] - $value;
                    }
                  }


                $file_storage = \Drupal::service('entity_type.manager')->getStorage('file');
                $file = $file_storage->load($arrShow['image']);
                if ($file) {
                    $file_path = $file->getFileUri(); // Получение пути к файлу.
                    $file_name = $file->getFilename(); // Получение имени файла.

                }
                $string = str_replace("public://", "", $file_path);
                $arrImg = "<img src='/sites/default/files/" . $string . "'>";
                    $stockInit = 0;
                    $elib = $countElib;
                    $solicitSQL = "SELECT COUNT(id) FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrShow['filiala3'] . "' AND premiu = '" . $arrShow['name3'] . "'";
                    $sol = $conn->query($solicitSQL);
                    foreach ($sol as $solVal) {
                        $solicit = $solVal['COUNT(id)'];
                    }
                    if($supliment == 0){
                      $updateGift = "UPDATE webform_submission_data SET value = 0 WHERE webform_id = 'cadouri' AND sid = '".$arrShow['sid']."' AND name = 'active' ";
                      if($conn->query($updateGift)){};
                    }
                    printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $arrShow['name3'], $arrImg, $arrShow['suplimentar3'], $count1,$count2,$count3,$count4,$count5,$count6,$count7,$count8, $supliment);

                    $count++;
                }

                print "</tbody>\n</table>\n";

                print <<<TABLE
                               <table id="table8">
                               <thead>
                               <tr><th>$grad 2</th><th>$premiuPoza</th><th>$premFil</th><th>$sapt 1</th><th>$sapt 2</th><th>$sapt 3</th><th>$sapt 4</th><th>$sapt 5</th><th>$sapt 6</th><th>$sapt 7</th><th>$sapt 8</th><th>$stoc_final</th></tr>
                               </thead>
                               <tbody>
                               TABLE;
                $count = 1;
                $solicit = 0;
                foreach ($arrShowF2 as $filiala => $arrShow) {

                  $date = new DateTime($dataVal['data']);
                  $date->add(new DateInterval('P7D'));
                  $week1 = $date->format('Y-m-d H:i:s');
                  $count1 = 0;
                  $getWeek1 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$dataVal['data']."' AND '".$week1."'";
                  $getWeekOne = $conn->query($getWeek1);
                  foreach ($getWeekOne as $Week1){
                    if($Week1['premiu'] == $arrShow['name2']){
                      $count1++;
                    }
                  }

                  $date = new DateTime($week1);
                  $date->add(new DateInterval('P7D'));
                  $count2=0;
                  $week2 = $date->format('Y-m-d H:i:s');
                  $getWeek2 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week1."' AND '".$week2."'";
                  $getWeekTwo = $conn->query($getWeek2);
                  foreach ($getWeekTwo as $Week2){
                    if($Week2['premiu'] == $arrShow['name2']){
                      $count2++;
                    }
                  }

                  $date = new DateTime($week2);
                  $date->add(new DateInterval('P7D'));
                  $count3=0;
                  $week3 = $date->format('Y-m-d H:i:s');
                  $getWeek3 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week2."' AND '".$week3."'";
                  $getWeekThree = $conn->query($getWeek3);
                  foreach ($getWeekThree as $Week3){
                    if($Week3['premiu'] == $arrShow['name2']){
                      $count3++;
                    }
                  }

                  $date = new DateTime($week3);
                  $date->add(new DateInterval('P7D'));
                  $count4=0;
                  $week4 = $date->format('Y-m-d H:i:s');
                  $getWeek4 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week3."' AND '".$week4."'";
                  $getWeekFour = $conn->query($getWeek4);
                  foreach ($getWeekFour as $Week4){
                    if($Week4['premiu'] == $arrShow['name2']){
                      $count4++;
                    }
                  }

                  $date = new DateTime($week4);
                  $date->add(new DateInterval('P7D'));
                  $count5=0;
                  $week5 = $date->format('Y-m-d H:i:s');
                  $getWeek5 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week4."' AND '".$week5."'";
                  $getWeekFive = $conn->query($getWeek5);
                  foreach ($getWeekFive as $Week5){
                    if($Week5['premiu'] == $arrShow['name2']){
                      $count5++;
                    }
                  }

                  $date = new DateTime($week5);
                  $date->add(new DateInterval('P7D'));
                  $count6=0;
                  $week6 = $date->format('Y-m-d H:i:s');
                  $getWeek6 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week5."' AND '".$week6."'";
                  $getWeekSix = $conn->query($getWeek6);
                  foreach ($getWeekSix as $Week6){
                    if($Week6['premiu'] == $arrShow['name2']){
                      $count6++;
                    }
                  }

                  $date = new DateTime($week6);
                  $date->add(new DateInterval('P7D'));
                  $count7=0;
                  $week7 = $date->format('Y-m-d H:i:s');
                  $getWeek7 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week6."' AND '".$week7."'";
                  $getWeekSeven = $conn->query($getWeek7);
                  foreach ($getWeekSeven as $Week7){
                    if($Week7['premiu'] == $arrShow['name2']){
                      $count7++;
                    }
                  }

                  $date = new DateTime($week7);
                  $date->add(new DateInterval('P7D'));
                  $count8 = 0;
                  $week8 = $date->format('Y-m-d H:i:s');
                  $getWeek8 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week7."' AND '".$week8."'";
                  $getWeekEight = $conn->query($getWeek8);
                  foreach ($getWeekEight as $Week8){
                    if($Week8['premiu'] == $arrShow['name2']){
                      $count8++;
                    }
                  }

                  foreach ($sums as $sum) {
                    if($sum['premiu'] == $arrShow['name2']){
                      $sum2 = $sum['total_suplimentar'] + $sum['total_initial'];
                    }
                  }
//                  if($arrShow['suplimentar2'] - $sum2 >= 0){
//                    $supliment = $arrShow['suplimentar2'] - $sum2;
//                  }else{
//                    $supliment = $arrShow['suplimentar2'];
//                }
                  $supliment = $arrShow['suplimentar2'];
                  foreach ($countedArray as $key => $value){
                    if($arrShow['name2'] == $key){
                      $supliment = $arrShow['suplimentar2'] - $value;
                    }
                  }

                $file_storage = \Drupal::service('entity_type.manager')->getStorage('file');
                $file = $file_storage->load($arrShow['image']);
                if ($file) {
                    $file_path = $file->getFileUri(); // Получение пути к файлу.
                    $file_name = $file->getFilename(); // Получение имени файла.

                }
                $string = str_replace("public://", "", $file_path);
                $arrImg = "<img src='/sites/default/files/" . $string . "'>";
                    $stockInit = 0;
                    $elib = $countElib;
                    $solicitSQL = "SELECT COUNT(id) FROM promo_code WHERE active != 0 AND status = 10 AND livrare = '" . $arrShow['filiala2'] . "' AND premiu = '" . $arrShow['name2'] . "'";
                    $sol = $conn->query($solicitSQL);
                    foreach ($sol as $solVal) {
                        $solicit = $solVal['COUNT(id)'];
                    }


                  if($supliment == 0){
                    $updateGift = "UPDATE webform_submission_data SET value = 0 WHERE webform_id = 'cadouri' AND sid = '".$arrShow['sid']."' AND name = 'active' ";
                    if($conn->query($updateGift)){};
                  }

                    printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $arrShow['name2'], $arrImg, $arrShow['suplimentar2'],  $count1,$count2,$count3,$count4,$count5,$count6,$count7,$count8, $supliment);

                    $count++;
                }

                print "</tbody>\n</table>\n";

                print <<<TABLE
                               <table id="table8">
                               <thead>
                               <tr><th>$grad 1</th><th>$premiuPoza</th><th>$premFil</th><th>$sapt 1</th><th>$sapt 2</th><th>$sapt 3</th><th>$sapt 4</th><th>$sapt 5</th><th>$sapt 6</th><th>$sapt 7</th><th>$sapt 8</th><th>$stoc_final</th></tr>
                               </thead>
                               <tbody>
                               TABLE;
                $count = 1;
                $solicit = 0;
                foreach ($arrShowF1 as $filiala => $arrShow) {
                  $date = new DateTime($dataVal['data']);
                  $date->add(new DateInterval('P7D'));
                  $week1 = $date->format('Y-m-d H:i:s');
                  $count1 = 0;
                  $getWeek1 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$dataVal['data']."' AND '".$week1."'";
                  $getWeekOne = $conn->query($getWeek1);
                  foreach ($getWeekOne as $Week1){
                    if($Week1['premiu'] == $arrShow['name1']){
                      $count1++;
                    }
                  }

                  $date = new DateTime($week1);
                  $date->add(new DateInterval('P7D'));
                  $count2=0;
                  $week2 = $date->format('Y-m-d H:i:s');
                  $getWeek2 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week1."' AND '".$week2."'";
                  $getWeekTwo = $conn->query($getWeek2);
                  foreach ($getWeekTwo as $Week2){
                    if($Week2['premiu'] == $arrShow['name1']){
                      $count2++;
                    }
                  }

                  $date = new DateTime($week2);
                  $date->add(new DateInterval('P7D'));
                  $count3=0;
                  $week3 = $date->format('Y-m-d H:i:s');
                  $getWeek3 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week2."' AND '".$week3."'";
                  $getWeekThree = $conn->query($getWeek3);
                  foreach ($getWeekThree as $Week3){
                    if($Week3['premiu'] == $arrShow['name1']){
                      $count3++;
                    }
                  }

                  $date = new DateTime($week3);
                  $date->add(new DateInterval('P7D'));
                  $count4=0;
                  $week4 = $date->format('Y-m-d H:i:s');
                  $getWeek4 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week3."' AND '".$week4."'";
                  $getWeekFour = $conn->query($getWeek4);
                  foreach ($getWeekFour as $Week4){
                    if($Week4['premiu'] == $arrShow['name1']){
                      $count4++;
                    }
                  }

                  $date = new DateTime($week4);
                  $date->add(new DateInterval('P7D'));
                  $count5=0;
                  $week5 = $date->format('Y-m-d H:i:s');
                  $getWeek5 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week4."' AND '".$week5."'";
                  $getWeekFive = $conn->query($getWeek5);
                  foreach ($getWeekFive as $Week5){
                    if($Week5['premiu'] == $arrShow['name1']){
                      $count5++;
                    }
                  }

                  $date = new DateTime($week5);
                  $date->add(new DateInterval('P7D'));
                  $count6=0;
                  $week6 = $date->format('Y-m-d H:i:s');
                  $getWeek6 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week5."' AND '".$week6."'";
                  $getWeekSix = $conn->query($getWeek6);
                  foreach ($getWeekSix as $Week6){
                    if($Week6['premiu'] == $arrShow['name1']){
                      $count6++;
                    }
                  }

                  $date = new DateTime($week6);
                  $date->add(new DateInterval('P7D'));
                  $count7=0;
                  $week7 = $date->format('Y-m-d H:i:s');
                  $getWeek7 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week6."' AND '".$week7."'";
                  $getWeekSeven = $conn->query($getWeek7);
                  foreach ($getWeekSeven as $Week7){
                    if($Week7['premiu'] == $arrShow['name1']){
                      $count7++;
                    }
                  }

                  $date = new DateTime($week7);
                  $date->add(new DateInterval('P7D'));
                  $count8 = 0;
                  $week8 = $date->format('Y-m-d H:i:s');
                  $getWeek8 = "SELECT * FROM promo_code WHERE status = 3 AND data BETWEEN '".$week7."' AND '".$week8."'";
                  $getWeekEight = $conn->query($getWeek8);
                  foreach ($getWeekEight as $Week8){
                    if($Week8['premiu'] == $arrShow['name1']){
                      $count8++;
                    }
                  }


                  foreach ($sums as $sum) {
                    if($sum['premiu'] == $arrShow['name1']){
                      $sum1 = $sum['total_suplimentar'] + $sum['total_initial'];
                    }
                  }
//                if($arrShow['suplimentar1'] - $sum1 >= 0){
//                                  $supliment = $arrShow['suplimentar1'] - $sum1;
//                }else{
//                  $supliment = $arrShow['suplimentar1'];
//                }
                  $supliment = $arrShow['suplimentar1'];
                  foreach ($countedArray as $key => $value){
                    if($arrShow['name1'] == $key){
                      $supliment = $arrShow['suplimentar1'] - $value;
                    }
                  }
                $file_storage = \Drupal::service('entity_type.manager')->getStorage('file');
                $file = $file_storage->load($arrShow['image']);
                if ($file) {
                    $file_path = $file->getFileUri(); // Получение пути к файлу.
                    $file_name = $file->getFilename(); // Получение имени файла.

                }
                $string = str_replace("public://", "", $file_path);
                $arrImg = "<img src='/sites/default/files/" . $string . "'>";

                    $stockInit = 0;
                    $elib = $countElib;
                    $solicitSQL = "SELECT COUNT(id) FROM promo_code WHERE active != 0 AND status = 2 AND livrare = '" . $arrShow['filiala1'] . "' AND premiu = '" . $arrShow['name1'] . "'";
                    $sol = $conn->query($solicitSQL);
                    foreach ($sol as $solVal) {

                        $solicit = $solVal['COUNT(id)'];
                    }
                  if($supliment == 0){
                    $updateGift = "UPDATE webform_submission_data SET value = 0 WHERE webform_id = 'cadouri' AND sid = '".$arrShow['sid']."' AND name = 'active' ";
                    if($conn->query($updateGift)){};
                  }
                    printf("<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $arrShow['name1'], $arrImg, $arrShow['suplimentar1'],  $count1,$count2,$count3,$count4,$count5,$count6,$count7,$count8, $supliment);

                    $count++;
                }

                print "</tbody>\n</table>\n";

          $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
          $filVal = $conn->query($getFiliala);
          if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ru') {
            $send = 'Отправить';
            $placeholder = "Начальный сток";
            $placeholder2 = "Дополнительно";
            $errPlace = "При добавлении произошла ошибка. Обратите внимание на наличие на складе";
            $closeErr = 'Закрыть';
          }
          if (\Drupal::languageManager()->getCurrentLanguage()->getId() == 'ro') {
            $send = 'Trimite';
            $placeholder = "Stoc initial";
            $placeholder2 = "Suplimentar";
            $errPlace = "A intervenit o eroare la adaugare. Atrageti atentie la stocul disponibil";
            $closeErr = 'Inchide';
          }
          print "<div class='form_principal'><form method='post'>";
          print "<select name='filiala_select' id=''>";
      foreach ($filVal as $fil){
          print "<option value='".$fil['value']."'>".$fil['value']."</option>";
      }
          print "</select>";
          print "<select name='gift_select' id=''>";
          foreach ($arrShowForm as $filiala => $arrShow) {
            print "<option value='".$arrShow['name']."'>".$arrShow['name']."</option>";
          }
          print "</select>";
          print "<input type='number' placeholder='".$placeholder2."' name='input_supliment'>
                        <input type='submit' name='submit_supliment' class='btn_main action search_filiala form_btn' value='".$send."'>";
          print "</form>";
          $getFiliala = "SELECT * FROM webform_submission_data WHERE webform_id = 'adaugarea_filiala' ";
          $filVal = $conn->query($getFiliala);
          print "<form method='post'>";
          print "<select name='filiala_select' id=''>";
          foreach ($filVal as $fil){
            print "<option value='".$fil['value']."'>".$fil['value']."</option>";
          }
          print "</select>";
          print "<select name='gift_select' id=''>";
          foreach ($arrShowForm as $filiala => $arrShow) {
            print "<option value='".$arrShow['name']."'>".$arrShow['name']."</option>";
          }
          print "</select>";
          print "<input type='number' placeholder='".$placeholder."' name='input_init'>
                        <input type='submit' name='submit_init' class='btn_main action search_filiala form_btn' value='".$send."'>";
          print "</form></div>";
$sumVal = 0;
          if(isset($_POST['submit_supliment'])){
            $getStock = "SELECT * FROM stock";
            $stockInfo = $conn->query($getStock);

            $combinedArray = array();
            foreach ($stockInfo as $info) {
              $premiuFiliala = $info['premiu'];

              if (!isset($combinedArray[$premiuFiliala])) {
                $combinedArray[$premiuFiliala] = array(
                  'initial' => 0,
                  'suplimentar' => 0,
                  'data' => ''
                );
              }

              $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
              $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
              $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
              $combinedArray[$premiuFiliala]['data'] = $info['data'];
            }
            $supl = 0;
            $initStock = 0;
            foreach ($combinedArray as $arrKey => $arrValue){
              if($arrValue['premiu'] == $_POST['gift_select']){
                $supl = $arrValue['suplimentar'];
                $initStock = $arrValue['initial'];
              }
            }

            foreach ($sums as $sum) {
              if($sum['premiu'] == $_POST['gift_select']){
                $sumVal += $sum['suplimentar'];
              }
            }
            foreach ($arrShowForm as $filiala => $arrShow) {
              if ($arrShow['name'] == $_POST['gift_select']) {
                if ($arrShow['suplimentar'] - (($supl + $initStock) + ($_POST['input_supliment'])) >= 0) {

                  $insertStock = "INSERT INTO stock (premiu, filiala, suplimentar, data)VALUES('".$_POST['gift_select']."', '".$_POST['filiala_select']."', '".$_POST['input_supliment']."', NOW())";
                  if ($conn->query($insertStock)) {
                    //echo "ok";
                  }
                }else {
                  print "<div class='error_popup'>".$errPlace."
                            <div class='btn_main action form_btn closeError'>".$closeErr."</div>
                        </div>";
                }
              }
            }
          }
          if(isset($_POST['submit_init'])){
            $getStock = "SELECT * FROM stock";
            $stockInfo = $conn->query($getStock);

            $combinedArray = array();
            foreach ($stockInfo as $info) {
              $premiuFiliala = $info['premiu'];

              if (!isset($combinedArray[$premiuFiliala])) {
                $combinedArray[$premiuFiliala] = array(
                  'initial' => 0,
                  'suplimentar' => 0,
                  'data' => ''
                );
              }

              $combinedArray[$premiuFiliala]['premiu'] = $info['premiu'];
              $combinedArray[$premiuFiliala]['initial'] += $info['initial'];
              $combinedArray[$premiuFiliala]['suplimentar'] += $info['suplimentar'];
              $combinedArray[$premiuFiliala]['data'] = $info['data'];
            }
            $supl = 0;
            $initStock = 0;
            foreach ($combinedArray as $arrKey => $arrValue){
              if($arrValue['premiu'] == $_POST['gift_select']){
                $supl = $arrValue['suplimentar'];
                $initStock = $arrValue['initial'];
              }
            }
            foreach ($sums as $sum) {
              if($sum['premiu'] == $_POST['gift_select']){
                $sumVal += $sum['suplimentar'];
              }
            }
            foreach ($arrShowForm as $filiala => $arrShow) {
              if ($arrShow['name'] == $_POST['gift_select']) {
                if ($arrShow['suplimentar'] - (($supl + $initStock) + ($_POST['input_init'])) >= 0) {
                  $insertStock = "INSERT INTO stock (premiu, filiala, initial, data)VALUES('".$_POST['gift_select']."', '".$_POST['filiala_select']."', '".$_POST['input_init']."', NOW())";
                  if ($conn->query($insertStock)) {
                    //echo "ok";
                  }
                }else {
                  print "<div class='error_popup'>".$errPlace."
                            <div class='btn_main action form_btn closeError'>".$closeErr."</div>
                        </div>";
                }
              }
            }
          }
          }
            }
}

